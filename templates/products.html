{% extends "base.html" %}

{% block title %}Products - Office Supplies System{% endblock %}

{% block extra_css %}
<style>
    .products-container {
        padding: 32px 0;
    }
    
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
    }
    
    .filters-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        margin-bottom: 32px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-label {
        font-weight: 500;
        color: var(--gray-700);
        font-size: 0.875rem;
    }
    
    .search-section {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 12px 16px;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }
    
    .product-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-blue);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }
    
    .product-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .product-category {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-bottom: 8px;
    }
    
    .product-details {
        margin-bottom: 16px;
    }
    
    .product-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }
    
    .product-info-label {
        color: var(--gray-600);
    }
    
    .product-info-value {
        font-weight: 500;
        color: var(--gray-900);
    }
    
    .product-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 4px;
    }
    
    .product-gst {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 16px;
    }
    
    .product-stock {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .stock-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .stock-high {
        background: var(--secondary-green);
    }
    
    .stock-medium {
        background: var(--secondary-orange);
    }
    
    .stock-low {
        background: var(--secondary-red);
    }
    
    .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
    }
    
    .btn-add-cart {
        flex: 1;
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-add-cart:hover {
        background: var(--primary-blue-dark);
        transform: translateY(-1px);
    }
    
    .btn-add-cart:disabled {
        background: var(--gray-300);
        cursor: not-allowed;
        transform: none;
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .quantity-input {
        width: 60px;
        padding: 8px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        text-align: center;
    }
    
    .quantity-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--gray-300);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
        background: var(--gray-50);
        border-color: var(--primary-blue);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-500);
        background: white;
        border-radius: 16px;
        border: 1px solid var(--gray-200);
        grid-column: 1 / -1;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .cart-summary {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        min-width: 200px;
        z-index: 100;
        display: none;
    }
    
    .cart-summary.show {
        display: block;
        animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .cart-items-count {
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 8px;
    }
    
    .cart-total {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 12px;
    }
    
    @media (max-width: 768px) {
        .products-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .search-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-input {
            min-width: auto;
        }
        
        .cart-summary {
            position: relative;
            bottom: auto;
            right: auto;
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="products-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    {% if current_user.role.startswith('vendor_') %}
                        Product Management
                    {% else %}
                        Product Catalog
                    {% endif %}
                </h1>
                <p style="color: var(--gray-600); margin: 8px 0 0 0;">
                    {% if current_user.role.startswith('vendor_') %}
                        Manage your product inventory and pricing
                    {% else %}
                        Browse and order office supplies
                    {% endif %}
                </p>
            </div>
            <div style="display: flex; gap: 12px;">
                {% if current_user.role == 'customer_employee' %}
                <button class="btn btn-secondary" onclick="viewCart()" id="viewCartBtn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    View Cart (<span id="cartCount">0</span>)
                </button>
                {% endif %}
                {% if current_user.role.startswith('vendor_') %}
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="form-control" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Price Range</label>
                    <select class="form-control" id="priceFilter">
                        <option value="">All Prices</option>
                        <option value="0-100">₹0 - ₹100</option>
                        <option value="100-500">₹100 - ₹500</option>
                        <option value="500-1000">₹500 - ₹1,000</option>
                        <option value="1000+">₹1,000+</option>
                    </select>
                </div>
                
                {% if current_user.role.startswith('vendor_') %}
                <div class="filter-group">
                    <label class="filter-label">Stock Status</label>
                    <select class="form-control" id="stockFilter">
                        <option value="">All Stock</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                {% endif %}
                
                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select class="form-control" id="sortFilter">
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="price_asc">Price (Low to High)</option>
                        <option value="price_desc">Price (High to Low)</option>
                        {% if current_user.role.startswith('vendor_') %}
                        <option value="stock_asc">Stock (Low to High)</option>
                        <option value="stock_desc">Stock (High to Low)</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            
            <div class="search-section">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search products by name, make, model..."
                >
                <button class="btn btn-primary" onclick="searchProducts()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <!-- Products will be loaded here -->
            <div style="grid-column: 1 / -1; padding: 40px; text-align: center;">
                <div class="spinner"></div>
                Loading products...
            </div>
        </div>
    </div>
</div>

<!-- Cart Summary (for customers) -->
{% if current_user.role == 'customer_employee' %}
<div class="cart-summary" id="cartSummary">
    <div class="cart-items-count" id="cartItemsText">0 items in cart</div>
    <div class="cart-total" id="cartTotalText">₹0.00</div>
    <button class="btn btn-primary btn-sm" onclick="viewCart()">
        <i class="fas fa-shopping-cart"></i>
        View Cart
    </button>
</div>
{% endif %}

<!-- Add Product Modal (for vendors) -->
{% if current_user.role.startswith('vendor_') %}
<div class="modal" id="addProductModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Add New Product</h3>
            <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" enctype="multipart/form-data">
                <!-- Basic Product Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Item Number <span style="color: var(--secondary-red);">*</span></label>
                        <input type="text" class="form-control" name="item_no" id="productItemNo" required>
                        <span class="form-help">Unique identifier for the product</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category <span style="color: var(--secondary-red);">*</span></label>
                        <select class="form-control" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Office Stationery">Office Stationery</option>
                            <option value="Computer Accessories">Computer Accessories</option>
                            <option value="Furniture">Furniture</option>
                            <option value="Office Equipment">Office Equipment</option>
                            <option value="Printing Supplies">Printing Supplies</option>
                            <option value="Storage & Organization">Storage & Organization</option>
                            <option value="Cleaning Supplies">Cleaning Supplies</option>
                            <option value="Safety Equipment">Safety Equipment</option>
                            <option value="Communication Equipment">Communication Equipment</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Product Name <span style="color: var(--secondary-red);">*</span></label>
                    <input type="text" class="form-control" name="product_name" required>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Make/Manufacturer</label>
                        <input type="text" class="form-control" name="product_make">
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="product_model">
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description/Details</label>
                    <textarea class="form-control" name="description" rows="3" placeholder="Product description, features, specifications..."></textarea>
                    <span class="form-error"></span>
                </div>
                
                <!-- Pricing and Stock Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Quantity <span style="color: var(--secondary-red);">*</span></label>
                        <input type="number" class="form-control" name="quantity" min="0" required>
                        <span class="form-help">Number of units in stock</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" class="form-control" name="low_stock_threshold" value="10" min="0">
                        <span class="form-help">Alert when stock falls below this number</span>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Rate (₹) <span style="color: var(--secondary-red);">*</span></label>
                        <input type="number" class="form-control" name="price" step="0.01" min="0" required>
                        <span class="form-help">Price per unit (excluding GST)</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">GST Rate (%)</label>
                        <select class="form-control" name="gst_rate">
                            <option value="0">0% (Exempt)</option>
                            <option value="5">5%</option>
                            <option value="12">12%</option>
                            <option value="18" selected>18%</option>
                            <option value="28">28%</option>
                        </select>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">HSN Code</label>
                    <input type="text" class="form-control" name="hsn_code" placeholder="e.g., 84713000">
                    <span class="form-help">Harmonized System of Nomenclature code for tax classification</span>
                    <span class="form-error"></span>
                </div>
                
                <!-- Product Image Upload -->
                <div class="form-group">
                    <label class="form-label">Product Image</label>
                    <input type="file" class="form-control" name="product_image" accept="image/jpeg,image/jpg,image/png,image/gif" onchange="handleImageUpload(event)">
                    <span class="form-help">Upload product image (JPG, PNG, GIF - max 10MB). Images will be automatically resized to 800x800 pixels.</span>
                    <span class="form-error" id="imageError"></span>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" style="margin-top: 12px; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; display: none;">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitAddProduct()">
                <i class="fas fa-plus"></i>
                Create Product
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    let currentProducts = [];
    let filteredProducts = [];
    let categories = [];
    let cart = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        setupEventListeners();
        
        {% if current_user.role == 'customer_employee' %}
        loadCart();
        {% endif %}
    });
    
    function setupEventListeners() {
        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });
        
        // Auto-search on filter changes
        ['categoryFilter', 'priceFilter', 'stockFilter', 'sortFilter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', searchProducts);
            }
        });
    }
    
    async function loadProducts() {
        try {
            const response = await apiCall('/products');
            const grid = document.getElementById('productsGrid');
            
            if (response.success && response.products) {
                currentProducts = response.products;
                filteredProducts = [...currentProducts];
                categories = response.categories || [];
                
                populateCategoryFilter();
                displayProducts();
            } else {
                showEmptyState('No products available');
            }
        } catch (error) {
            console.error('Error loading products:', error);
            showEmptyState('Error loading products');
        }
    }
    
    function populateCategoryFilter() {
        const categoryFilter = document.getElementById('categoryFilter');
        const uniqueCategories = [...new Set(currentProducts.map(p => p.category))];
        
        categoryFilter.innerHTML = '<option value="">All Categories</option>' +
            uniqueCategories.map(category => 
                `<option value="${category}">${category}</option>`
            ).join('');
    }
    
    function displayProducts() {
        const grid = document.getElementById('productsGrid');
        
        if (filteredProducts.length === 0) {
            showEmptyState('No products found');
            return;
        }
        
        grid.innerHTML = filteredProducts.map(product => `
            <div class="product-card">
                <div class="product-header">
                    <div>
                        <div class="product-category">${product.category}</div>
                        <div class="product-name">${product.product_name}</div>
                    </div>
                    ${getStockIndicator(product)}
                </div>
                
                <div class="product-details">
                    ${product.product_make ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Make:</span>
                            <span class="product-info-value">${product.product_make}</span>
                        </div>
                    ` : ''}
                    ${product.product_model ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Model:</span>
                            <span class="product-info-value">${product.product_model}</span>
                        </div>
                    ` : ''}
                    <div class="product-info-row">
                        <span class="product-info-label">Item No:</span>
                        <span class="product-info-value">${product.item_no}</span>
                    </div>
                    {% if current_user.role.startswith('vendor_') %}
                    <div class="product-info-row">
                        <span class="product-info-label">Stock:</span>
                        <span class="product-info-value">${product.quantity} units</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="product-price">₹${product.price.toLocaleString('en-IN')}</div>
                <div class="product-gst">+ ₹${((product.price * product.gst_rate) / 100).toFixed(2)} GST (${product.gst_rate}%)</div>
                
                ${getProductActions(product)}
            </div>
        `).join('');
    }
    
    function getStockIndicator(product) {
        {% if current_user.role.startswith('vendor_') %}
        const stockLevel = product.quantity;
        const threshold = product.low_stock_threshold || 10;
        
        let indicatorClass = 'stock-high';
        let stockText = 'In Stock';
        
        if (stockLevel === 0) {
            indicatorClass = 'stock-low';
            stockText = 'Out of Stock';
        } else if (stockLevel <= threshold) {
            indicatorClass = 'stock-medium';
            stockText = 'Low Stock';
        }
        
        return `
            <div class="product-stock">
                <div class="stock-indicator ${indicatorClass}"></div>
                <span style="font-size: 0.875rem; color: var(--gray-600);">${stockText}</span>
            </div>
        `;
        {% else %}
        return '';
        {% endif %}
    }
    
    function getProductActions(product) {
        {% if current_user.role == 'customer_employee' %}
        const isOutOfStock = product.quantity === 0;
        
        return `
            <div class="quantity-selector">
                <button class="quantity-btn" onclick="changeQuantity('${product.product_id}', -1)" ${isOutOfStock ? 'disabled' : ''}>
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" class="quantity-input" id="qty_${product.product_id}" value="1" min="1" max="${product.quantity}" ${isOutOfStock ? 'disabled' : ''}>
                <button class="quantity-btn" onclick="changeQuantity('${product.product_id}', 1)" ${isOutOfStock ? 'disabled' : ''}>
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="product-actions">
                <button class="btn-add-cart" onclick="addToCart('${product.product_id}')" ${isOutOfStock ? 'disabled' : ''}>
                    <i class="fas fa-shopping-cart"></i>
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
            </div>
        `;
        {% elif current_user.role.startswith('vendor_') %}
        return `
            <div class="product-actions">
                <button class="btn btn-secondary btn-sm" onclick="editProduct('${product.product_id}')">
                    <i class="fas fa-edit"></i>
                    Edit
                </button>
                <button class="btn btn-primary btn-sm" onclick="viewProduct('${product.product_id}')">
                    <i class="fas fa-eye"></i>
                    View
                </button>
            </div>
        `;
        {% else %}
        return '';
        {% endif %}
    }
    
    function searchProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const priceRange = document.getElementById('priceFilter').value;
        const stockFilter = document.getElementById('stockFilter')?.value || '';
        const sortBy = document.getElementById('sortFilter').value;
        
        filteredProducts = currentProducts.filter(product => {
            // Search filter
            const matchesSearch = !searchTerm || 
                product.product_name.toLowerCase().includes(searchTerm) ||
                (product.product_make && product.product_make.toLowerCase().includes(searchTerm)) ||
                (product.product_model && product.product_model.toLowerCase().includes(searchTerm)) ||
                product.item_no.toLowerCase().includes(searchTerm);
            
            // Category filter
            const matchesCategory = !category || product.category === category;
            
            // Price filter
            let matchesPrice = true;
            if (priceRange) {
                const price = product.price;
                switch (priceRange) {
                    case '0-100':
                        matchesPrice = price <= 100;
                        break;
                    case '100-500':
                        matchesPrice = price > 100 && price <= 500;
                        break;
                    case '500-1000':
                        matchesPrice = price > 500 && price <= 1000;
                        break;
                    case '1000+':
                        matchesPrice = price > 1000;
                        break;
                }
            }
            
            // Stock filter (vendor only)
            let matchesStock = true;
            {% if current_user.role.startswith('vendor_') %}
            if (stockFilter) {
                const stock = product.quantity;
                const threshold = product.low_stock_threshold || 10;
                
                switch (stockFilter) {
                    case 'in-stock':
                        matchesStock = stock > threshold;
                        break;
                    case 'low-stock':
                        matchesStock = stock > 0 && stock <= threshold;
                        break;
                    case 'out-of-stock':
                        matchesStock = stock === 0;
                        break;
                }
            }
            {% endif %}
            
            return matchesSearch && matchesCategory && matchesPrice && matchesStock;
        });
        
        // Apply sorting
        filteredProducts.sort((a, b) => {
            switch (sortBy) {
                case 'name_asc':
                    return a.product_name.localeCompare(b.product_name);
                case 'name_desc':
                    return b.product_name.localeCompare(a.product_name);
                case 'price_asc':
                    return a.price - b.price;
                case 'price_desc':
                    return b.price - a.price;
                {% if current_user.role.startswith('vendor_') %}
                case 'stock_asc':
                    return a.quantity - b.quantity;
                case 'stock_desc':
                    return b.quantity - a.quantity;
                {% endif %}
                default:
                    return 0;
            }
        });
        
        displayProducts();
    }
    
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('priceFilter').value = '';
        if (document.getElementById('stockFilter')) {
            document.getElementById('stockFilter').value = '';
        }
        document.getElementById('sortFilter').value = 'name_asc';
        
        searchProducts();
    }
    
    function showEmptyState(message) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-box"></i>
                </div>
                <h3>${message}</h3>
                <p>Products will appear here when available.</p>
                {% if current_user.role.startswith('vendor_') %}
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                {% endif %}
            </div>
        `;
    }
    
    {% if current_user.role == 'customer_employee' %}
    // Cart functionality for customers
    function changeQuantity(productId, change) {
        const input = document.getElementById(`qty_${productId}`);
        const currentValue = parseInt(input.value);
        const newValue = Math.max(1, currentValue + change);
        const maxValue = parseInt(input.max);
        
        input.value = Math.min(newValue, maxValue);
    }
    
    function addToCart(productId) {
        const product = currentProducts.find(p => p.product_id === productId);
        const quantityInput = document.getElementById(`qty_${productId}`);
        const quantity = parseInt(quantityInput.value);
        
        if (!product || quantity <= 0) {
            showNotification('Invalid product or quantity', 'error');
            return;
        }
        
        // Check if product already in cart
        const existingItemIndex = cart.findIndex(item => item.product_id === productId);
        
        if (existingItemIndex >= 0) {
            cart[existingItemIndex].quantity += quantity;
        } else {
            cart.push({
                product_id: productId,
                product_name: product.product_name,
                price: product.price,
                quantity: quantity,
                total: product.price * quantity
            });
        }
        
        saveCart();
        updateCartDisplay();
        showNotification(`${product.product_name} added to cart!`, 'success');
        
        // Reset quantity to 1
        quantityInput.value = 1;
    }
    
    function loadCart() {
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            updateCartDisplay();
        }
    }
    
    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }
    
    function updateCartDisplay() {
        const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartTotal = cart.reduce((sum, item) => sum + item.total, 0);
        
        document.getElementById('cartCount').textContent = cartCount;
        document.getElementById('cartItemsText').textContent = `${cartCount} item${cartCount !== 1 ? 's' : ''} in cart`;
        document.getElementById('cartTotalText').textContent = `₹${cartTotal.toLocaleString('en-IN')}`;
        
        const viewCartBtn = document.getElementById('viewCartBtn');
        const cartSummary = document.getElementById('cartSummary');
        
        if (cartCount > 0) {
            viewCartBtn.style.display = 'block';
            cartSummary.classList.add('show');
        } else {
            viewCartBtn.style.display = 'none';
            cartSummary.classList.remove('show');
        }
    }
    
    function viewCart() {
        // Navigate to cart/checkout page
        window.location.href = '/cart';
    }
    {% endif %}
    
    {% if current_user.role.startswith('vendor_') %}
    // Vendor functions
    function showAddProductModal() {
        document.getElementById('addProductModal').classList.add('show');
        
        // Focus first field
        setTimeout(() => {
            const productNameField = document.querySelector('#addProductModal [name="product_name"]');
            if (productNameField) {
                productNameField.focus();
            }
        }, 100);
    }
    
    function closeAddProductModal() {
        document.getElementById('addProductModal').classList.remove('show');
        document.getElementById('addProductForm').reset();
        
        // Clear image preview
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
            imagePreview.style.display = 'none';
            imagePreview.innerHTML = '';
        }
    }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        const imagePreview = document.getElementById('imagePreview');
        const imageError = document.getElementById('imageError');
        
        // Clear previous states
        imagePreview.style.display = 'none';
        imagePreview.innerHTML = '';
        imageError.style.display = 'none';
        
        if (!file) return;
        
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            imageError.textContent = 'Please select a valid image file (JPG, PNG, GIF)';
            imageError.style.display = 'block';
            event.target.value = '';
            return;
        }
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            imageError.textContent = 'Image file size should be less than 10MB';
            imageError.style.display = 'block';
            event.target.value = '';
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.innerHTML = `
                <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                <div style="margin-top: 8px; font-size: 0.875rem; color: var(--gray-600);">
                    ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                </div>
            `;
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    function generateItemNumber() {
        // Generate a unique item number
        const timestamp = Date.now().toString().slice(-8);
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `ITM${timestamp}${random}`;
    }
    
    async function submitAddProduct() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const requiredFields = ['item_no', 'product_name', 'category', 'price', 'quantity'];
        let isValid = true;
        
        for (const field of requiredFields) {
            const input = form.querySelector(`[name="${field}"]`);
            const errorSpan = input.parentNode.querySelector('.form-error');
            
            if (!input.value.trim()) {
                if (errorSpan) {
                    errorSpan.textContent = `${field.replace('_', ' ')} is required`;
                    errorSpan.style.display = 'block';
                }
                input.style.borderColor = 'var(--secondary-red)';
                isValid = false;
            } else {
                if (errorSpan) {
                    errorSpan.style.display = 'none';
                }
                input.style.borderColor = 'var(--gray-300)';
            }
        }
        
        if (!isValid) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            // Show loading state
            const submitBtn = document.querySelector('#addProductModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            submitBtn.disabled = true;
            
            const response = await fetch('/api/products', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Product created successfully!', 'success');
                closeAddProductModal();
                loadProducts(); // Reload products list
            } else {
                showNotification(result.message || 'Failed to create product', 'error');
            }
        } catch (error) {
            console.error('Error creating product:', error);
            showNotification('Failed to create product', 'error');
        } finally {
            // Restore button state
            const submitBtn = document.querySelector('#addProductModal .btn-primary');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    function editProduct(productId) {
        showNotification('Edit Product functionality coming soon!', 'info');
    }
    
    function viewProduct(productId) {
        showNotification('View Product functionality coming soon!', 'info');
    }
    
    // Generate item number when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const itemNoField = document.getElementById('productItemNo');
        if (itemNoField) {
            itemNoField.value = generateItemNumber();
        }
    });
    {% endif %}
</script>
{% endblock %}