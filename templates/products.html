{% extends "base.html" %}

{% block title %}Products - Office Supplies System{% endblock %}

{% block extra_css %}
<style>
    /* Placeholder for missing product images */
    .product-image-placeholder {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
        font-size: 48px;
        border: 1px solid var(--gray-200);
    }

    .product-image-placeholder i {
        opacity: 0.5;
    }

    /* Modal improvements */
    .modal-content {
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @media (max-width: 768px) {
        .modal-body > div:first-child {
            grid-template-columns: 1fr !important;
            gap: 16px !important;
        }
        
        .product-card {
            padding: 12px;
        }
    }

    .products-container {
        padding: 32px 0;
    }
    
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
    }

    .customer-filter-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .customer-filter-section {
        width: 300px;
    }

    .filters-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        margin-bottom: 32px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-label {
        font-weight: 500;
        color: var(--gray-700);
        font-size: 0.875rem;
    }
    
    .search-section {
        margin-top: 16px;
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 12px 16px;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }
    
    .product-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: fit-content;
    }
    
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-blue);
    }

    .product-card img {
        transition: opacity 0.3s ease;
    }

    .product-card img[src=""] {
        display: none;
    }
    
    .product-card:hover img {
        transform: scale(1.02);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 5px;
    }
    
    .product-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .product-category {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-bottom: 8px;
    }
    
    .product-details {
        margin-bottom: 16px;
    }
    
    .product-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }
    
    .product-info-label {
        color: var(--gray-600);
    }
    
    .product-info-value {
        font-weight: 500;
        color: var(--gray-900);
    }
    
    /* Updated pricing styles for editable rates */
    .product-price-section {
        margin-bottom: 5px;
        padding: 5px;
        background: var(--gray-50);
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .product-price-section.editable {
        border-color: var(--primary-blue);
        background: rgba(37, 99, 235, 0.05);
    }
    
    .product-price {
        font-size: 1rem;
        font-weight: 500;
        color: var(--primary-blue);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .price-input {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        background: none;
        border: none;
        outline: none;
        width: 120px;
        padding: 2px;
        border-bottom: 2px solid var(--primary-blue);
    }
    
    .price-actions {
        display: none;
        gap: 4px;
        margin-left: auto;
    }
    
    .product-price-section.editing .price-actions {
        display: flex;
    }
    
    .price-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .price-btn.save {
        background: var(--secondary-green);
        color: white;
    }
    
    .price-btn.cancel {
        background: var(--gray-400);
        color: white;
    }
    
    .price-btn:hover {
        transform: scale(1.1);
    }
    
    .base-price-indicator {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: normal;
        margin-top: 2px;
    }
    
    .custom-price-indicator {
        font-size: 0.75rem;
        color: var(--secondary-green);
        font-weight: 500;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .product-gst {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 8px;
    }
    
    .no-customer-message {
        flex: 1;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 12px 16px;
        border-radius: 6px;
        color: #856404;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .product-stock {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .stock-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .stock-high {
        background: var(--secondary-green);
    }
    
    .stock-medium {
        background: var(--secondary-orange);
    }
    
    .stock-low {
        background: var(--secondary-red);
    }
    
    .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
    }
    
    .btn-add-cart {
        flex: 1;
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-add-cart:hover {
        background: var(--primary-blue-dark);
        transform: translateY(-1px);
    }

    .btn-add-cart:hover:not(:disabled) {
        background: var(--primary-blue-dark) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .btn-add-cart:disabled {
        background: var(--gray-400) !important;
        cursor: not-allowed;
        transform: none !important;
    }

    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .quantity-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .quantity-input {
        width: 60px;
        padding: 8px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        text-align: center;
    }
    
    .quantity-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--gray-300);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
        background: var(--gray-50);
        border-color: var(--primary-blue);
    }

    .quantity-btn:hover:not(:disabled) {
        background: var(--gray-50) !important;
        border-color: var(--primary-blue) !important;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-500);
        background: white;
        border-radius: 16px;
        border: 1px solid var(--gray-200);
        grid-column: 1 / -1;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .cart-summary {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        min-width: 200px;
        z-index: 100;
        display: none;
    }
    
    .cart-summary.show {
        display: block;
        animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .cart-items-count {
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 8px;
    }
    
    .cart-total {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 12px;
    }
    
    @media (max-width: 768px) {
        .products-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .search-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-input {
            min-width: auto;
        }
        
        .cart-summary {
            position: relative;
            bottom: auto;
            right: auto;
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="products-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    {% if current_user.role.startswith('vendor_') %}
                        Product Management
                    {% else %}
                        Product Catalog
                    {% endif %}
                </h1>
                <p style="color: var(--gray-600); margin: 8px 0 0 0;">
                    {% if current_user.role.startswith('vendor_') %}
                        Manage your product inventory and customer-specific pricing
                    {% else %}
                        Browse and order office supplies
                    {% endif %}
                </p>
            </div>
            <div style="display: flex; gap: 12px;">
                {% if current_user.role == 'customer_employee' %}
                <button class="btn btn-secondary" onclick="viewCart()" id="viewCartBtn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    View Cart (<span id="cartCount">0</span>)
                </button>
                {% endif %}
                {% if current_user.role.startswith('vendor_') %}
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="form-control" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Price Range</label>
                    <select class="form-control" id="priceFilter">
                        <option value="">All Prices</option>
                        <option value="0-100">‚Çπ0 - ‚Çπ100</option>
                        <option value="100-500">‚Çπ100 - ‚Çπ500</option>
                        <option value="500-1000">‚Çπ500 - ‚Çπ1,000</option>
                        <option value="1000+">‚Çπ1,000+</option>
                    </select>
                </div>

                {% if current_user.role.startswith('vendor_') %}
                <div class="filter-group">
                    <label class="filter-label">Stock Status</label>
                    <select class="form-control" id="stockFilter">
                        <option value="">All Stock</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                {% endif %}

                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select class="form-control" id="sortFilter">
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="price_asc">Price (Low to High)</option>
                        <option value="price_desc">Price (High to Low)</option>
                        {% if current_user.role.startswith('vendor_') %}
                        <option value="stock_asc">Stock (Low to High)</option>
                        <option value="stock_desc">Stock (High to Low)</option>
                        {% endif %}
                    </select>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search products by name, make, model..."
                >
                <button class="btn btn-primary" onclick="searchProducts()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>

        {% if current_user.role.startswith('vendor_') %}
        <!-- Wrapper for left-right alignment -->
        <div class="customer-filter-wrapper">
            <!-- Left side: Customer dropdown -->
            <div class="customer-filter-section">
                <div class="filter-group">
                    <select class="form-control" id="customerFilterProducts">
                        <option value="">Select Customer to Edit Pricing</option>
                    </select>
                </div>
            </div>

            <!-- Right side: Info message -->
            <div class="no-customer-message" id="noCustomerMessage">
                <i class="fas fa-arrow-circle-left"></i>
                Select a customer from the dropdown to view and edit customer-specific pricing
            </div>
        </div>
        {% endif %}

        <div class="products-grid" id="productsGrid">
            <!-- Products will be loaded here -->
            <div style="grid-column: 1 / -1; padding: 40px; text-align: center;">
                <div class="spinner"></div>
                Loading products...
            </div>
        </div>
    </div>
</div>

<!-- Cart Summary (for customers) -->
{% if current_user.role == 'customer_employee' %}
<div class="cart-summary" id="cartSummary">
    <div class="cart-items-count" id="cartItemsText">0 items in cart</div>
    <div class="cart-total" id="cartTotalText">‚Çπ0.00</div>
    <button class="btn btn-primary btn-sm" onclick="viewCart()">
        <i class="fas fa-shopping-cart"></i>
        View Cart
    </button>
</div>
{% endif %}

<!-- Add Product Modal (for vendors) -->
{% if current_user.role.startswith('vendor_') %}
<div class="modal" id="addProductModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Add New Product</h3>
            <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" enctype="multipart/form-data">
                <!-- Basic Product Information -->
                <div class="form-row">
                    <!-- Item Number Auto-Generated Info -->
                    <div class="form-group">
                        <label class="form-label">Item Number</label>
                        <div style="padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-300); border-radius: 8px; color: var(--gray-600);">
                            <i class="fas fa-magic"></i>
                            Auto-generated (itXXXXX format)
                        </div>
                        <span class="form-help">Item number will be automatically assigned when product is created</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category <span style="color: var(--secondary-red);">*</span></label>
                        <select class="form-control" name="category" required>
                            <option value="">Loading categories...</option>
                        </select>
                        <div style="margin-top: 4px;">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="refreshProductFormCategories()" title="Refresh categories">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <a href="/categories" class="btn btn-sm btn-primary" target="_blank" title="Manage categories in new tab">
                                <i class="fas fa-tags"></i>
                                Manage Categories
                            </a>
                        </div>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Product Name <span style="color: var(--secondary-red);">*</span></label>
                    <input type="text" class="form-control" name="product_name" required>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Make/Manufacturer</label>
                        <input type="text" class="form-control" name="product_make">
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="product_model">
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description/Details</label>
                    <textarea class="form-control" name="description" rows="3" placeholder="Product description, features, specifications..."></textarea>
                    <span class="form-error"></span>
                </div>
                
                <!-- Stock Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Quantity <span style="color: var(--secondary-red);">*</span></label>
                        <input type="number" class="form-control" name="quantity" min="0" required>
                        <span class="form-help">Number of units in stock</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" class="form-control" name="low_stock_threshold" value="10" min="0">
                        <span class="form-help">Alert when stock falls below this number</span>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <!-- Note about pricing -->
                <div class="form-group">
                    <div style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3); border-radius: 8px; padding: 16px; color: var(--primary-blue);">
                        <i class="fas fa-info-circle"></i>
                        <strong>Pricing:</strong> After creating the product, set customer-specific pricing using the pricing editor on the products page.
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">GST Rate (%)</label>
                    <select class="form-control" name="gst_rate">
                        <option value="0">0% (Exempt)</option>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18" selected>18%</option>
                        <option value="28">28%</option>
                    </select>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">HSN Code</label>
                    <input type="text" class="form-control" name="hsn_code" placeholder="e.g., 84713000">
                    <span class="form-help">Harmonized System of Nomenclature code for tax classification</span>
                    <span class="form-error"></span>
                </div>
                
                <!-- Product Image Upload -->
                <div class="form-group">
                    <label class="form-label">Product Image</label>
                    <input type="file" 
                        class="form-control" 
                        name="product_image" 
                        accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/tiff,image/svg+xml,image/x-icon,image/avif,image/jfif" 
                        onchange="handleImageUpload(event)">
                    <span class="form-help">Upload product image (All image formats supported - JPEG, PNG, GIF, WebP, BMP, TIFF, SVG, ICO, AVIF - max 16MB). Images will be automatically resized to 800x800 pixels.</span>
                    <span class="form-error" id="imageError"></span>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" style="margin-top: 12px; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; display: none;">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitAddProduct()">
                <i class="fas fa-plus"></i>
                Create Product
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Complete JavaScript for products.html - FULL VERSION

let currentProducts = [];
let filteredProducts = [];
let categories = [];
let cart = [];
let selectedCustomerId = null;
let customerPricing = {};

// Get user role from template safely
const USER_ROLE = '{{ current_user.role if current_user else "none" }}';
const IS_CUSTOMER = USER_ROLE.startsWith('customer_');
const IS_VENDOR = USER_ROLE.startsWith('vendor_');

console.log('User role:', USER_ROLE);
console.log('Is customer:', IS_CUSTOMER);
console.log('Is vendor:', IS_VENDOR);

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing products page');
    loadProducts();
    setupEventListeners();
    
    // Load categories for product forms
    loadCategoriesForProductForm();
    
    if (IS_CUSTOMER) {
        loadCart();
    }
    
    if (IS_VENDOR) {
        setupCustomerPricingSystem();
    }
});

async function loadProducts() {
    try {
        console.log('Loading products...');
        const response = await apiCall('/products');
        console.log('Products response:', response);
        
        const grid = document.getElementById('productsGrid');
        
        if (response.success && response.products) {
            console.log('Products loaded successfully:', response.products.length);
            currentProducts = response.products;
            filteredProducts = [...currentProducts];
            
            // Load categories dynamically instead of using hardcoded ones
            await loadCategoriesForProductForm();
            
            displayProducts();
        } else {
            console.error('Failed to load products:', response);
            showEmptyState('No products available');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        showEmptyState('Error loading products');
    }
}

// Add a function to refresh categories when user navigates back from categories page
function refreshCategoriesFromCategoriesPage() {
    // This can be called when user returns from the categories management page
    console.log('Refreshing categories after category management...');
    loadCategoriesForProductForm();
}

// Listen for focus events to refresh categories when user returns to products page
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && window.location.pathname === '/products') {
        // Page became visible, refresh categories in case they were updated
        console.log('Products page became visible, refreshing categories...');
        refreshProductFormCategories();
    }
});

// Also listen for focus events on the window
window.addEventListener('focus', function() {
    if (window.location.pathname === '/products') {
        console.log('Products page gained focus, refreshing categories...');
        refreshProductFormCategories();
    }
});

function displayProducts() {
    const grid = document.getElementById('productsGrid');
    
    if (filteredProducts.length === 0) {
        showEmptyState('No products found');
        return;
    }
    
    console.log('Displaying products for role:', USER_ROLE);
    
    if (IS_CUSTOMER) {
        displayCustomerProducts();
    } else if (IS_VENDOR) {
        displayVendorProducts();
    }
    
    console.log('Products displayed successfully');
}

function displayCustomerProducts() {
    const grid = document.getElementById('productsGrid');
    
    grid.innerHTML = filteredProducts.map(product => {
        const isOutOfStock = product.quantity === 0;
        const effectivePrice = product.custom_price || product.price || 0;
        const gstAmount = (effectivePrice * (product.gst_rate || 18)) / 100;
        
        // Handle product image
        let productImage = '';
        if (product.image_urls && product.image_urls.length > 0) {
            productImage = product.image_urls[0];
            if (productImage && !productImage.startsWith('http') && !productImage.startsWith('/uploads/')) {
                productImage = `/uploads/products/${productImage}`;
            }
        }
        
        // Skip products without pricing
        if (effectivePrice === 0 && !product.custom_price) {
            return '';
        }
        
        return `
            <div class="product-card" onclick="viewProductDetails('${product.product_id}')" style="cursor: pointer;">
                <!-- Product Name -->
                <div style="text-align: left; margin-bottom: 16px; font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">
                    ${product.product_name}
                </div>
                
                <!-- Product Image -->
                <div style="text-align: center; margin-bottom: 16px;">
                    ${productImage ? `
                        <img src="${productImage}" 
                             alt="${product.product_name}" 
                             style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 100%; height: 200px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                            <i class="fas fa-box"></i>
                        </div>
                    ` : `
                        <div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                            <i class="fas fa-box"></i>
                        </div>
                    `}
                </div>
                
                <!-- Product Details -->
                <div style="margin-bottom: 16px;">
                    ${product.product_make ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Make:</span>
                            <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.product_make}</span>
                        </div>
                    ` : ''}
                    
                    ${product.product_model ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Model:</span>
                            <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.product_model}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray-600); font-size: 0.875rem;">Category:</span>
                        <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.category}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray-600); font-size: 0.875rem;">Item No:</span>
                        <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.item_no}</span>
                    </div>
                </div>
                
                <!-- Price Section -->
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 4px;">
                        ‚Çπ${effectivePrice.toLocaleString('en-IN')}
                        ${product.custom_price ? '<span style="font-size: 0.75rem; color: var(--secondary-green); margin-left: 8px;">Special Price</span>' : ''}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500);">
                        + ‚Çπ${gstAmount.toFixed(2)} GST (${product.gst_rate || 18}%)
                    </div>
                </div>
                
                <!-- Action Section -->
                <div onclick="event.stopPropagation()" style="display: flex; gap: 12px;">
                    <!-- Qty Section -->
                    <div style="flex: 1; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; align-items: center;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Quantity</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="changeQuantity('${product.product_id}', -1)" 
                                    ${isOutOfStock ? 'disabled' : ''} 
                                    style="width: 28px; height: 28px; border: 1px solid var(--gray-300); background: white; border-radius: 4px; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'}; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                   id="qty_${product.product_id}" 
                                   value="1" 
                                   min="1" 
                                   max="${product.quantity}" 
                                   ${isOutOfStock ? 'disabled' : ''} 
                                   style="width: 50px; padding: 6px; border: 1px solid var(--gray-300); border-radius: 4px; text-align: center; font-size: 0.875rem; font-weight: 600;">
                            <button onclick="changeQuantity('${product.product_id}', 1)" 
                                    ${isOutOfStock ? 'disabled' : ''} 
                                    style="width: 28px; height: 28px; border: 1px solid var(--gray-300); background: white; border-radius: 4px; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'}; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- +Cart Section -->
                    <div style="flex: 1;">
                        <button onclick="addToCart('${product.product_id}')" 
                                ${isOutOfStock ? 'disabled' : ''} 
                                data-price="${effectivePrice}" 
                                style="width: 100%; height: 100%; background: ${isOutOfStock ? 'var(--gray-400)' : 'var(--primary-sky-blue)'}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'}; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: all 0.3s ease;">
                            <i class="fas fa-cart-plus" style="font-size: 1.25rem;"></i>
                            <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${isOutOfStock ? 'Out of Stock' : '+Cart'}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).filter(card => card !== '').join('');
    
    if (grid.innerHTML.trim() === '') {
        showEmptyState('No products available with pricing');
    }
}

function displayVendorProducts() {
    const grid = document.getElementById('productsGrid');
    
    grid.innerHTML = filteredProducts.map(product => {
        // Handle product image
        let productImage = '';
        if (product.image_urls && product.image_urls.length > 0) {
            productImage = product.image_urls[0];
            if (productImage && !productImage.startsWith('http') && !productImage.startsWith('/uploads/')) {
                productImage = `/uploads/products/${productImage}`;
            }
        }
        
        return `
            <div class="product-card">
                <div class="product-header">
                    <div>
                        <div class="product-category">${product.category}</div>
                        <div class="product-name">${product.product_name}</div>
                    </div>
                    ${getStockIndicator(product)}
                </div>
                
                <!-- Product Image for Vendor -->
                <div style="text-align: center; margin-bottom: 16px;">
                    ${productImage ? `
                        <img src="${productImage}" 
                             alt="${product.product_name}" 
                             style="max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 100%; height: 150px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; align-items: center; justify-content: center; color: var(--gray-500); font-size: 36px; border: 1px solid var(--gray-200);">
                            <i class="fas fa-image"></i>
                        </div>
                    ` : `
                        <div style="width: 100%; height: 150px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 36px; border: 1px solid var(--gray-200);">
                            <i class="fas fa-image"></i>
                        </div>
                    `}
                </div>
                
                <div class="product-details">
                    ${product.product_make ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Make:</span>
                            <span class="product-info-value">${product.product_make}</span>
                        </div>
                    ` : ''}
                    ${product.product_model ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Model:</span>
                            <span class="product-info-value">${product.product_model}</span>
                        </div>
                    ` : ''}
                    <div class="product-info-row">
                        <span class="product-info-label">Item No:</span>
                        <span class="product-info-value" style="font-family: monospace; background: var(--gray-100); padding: 2px 6px; border-radius: 4px;">${product.item_no}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Stock:</span>
                        <span class="product-info-value">${product.quantity} units</span>
                    </div>
                </div>
                
                ${getPriceSection(product)}
                ${getProductActions(product)}
            </div>
        `;
    }).join('');
}

function getStockIndicator(product) {
    let stockClass = 'stock-high';
    let stockText = 'In Stock';
    
    if (product.quantity === 0) {
        stockClass = 'stock-low';
        stockText = 'Out of Stock';
    } else if (product.quantity <= (product.low_stock_threshold || 10)) {
        stockClass = 'stock-medium';
        stockText = 'Low Stock';
    }
    
    return `
        <div class="product-stock">
            <div class="stock-indicator ${stockClass}"></div>
            <span>${stockText}</span>
        </div>
    `;
}

function getPriceSection(product) {
    return `
        <div class="product-price-section" id="price-section-${product.product_id}">
            <div class="product-price">
                Base Price: ‚Çπ${(product.price || 0).toLocaleString('en-IN')}
            </div>
            <div class="product-gst">
                + ${product.gst_rate || 18}% GST
            </div>
        </div>
    `;
}

function getProductActions(product) {
    return `
        <div class="product-actions">
            <button class="btn btn-secondary btn-sm" onclick="viewProductDetails('${product.product_id}')">
                <i class="fas fa-eye"></i>
                View Details
            </button>
            <button class="btn btn-primary btn-sm" onclick="editProduct('${product.product_id}')">
                <i class="fas fa-edit"></i>
                Edit
            </button>
        </div>
    `;
}

// Setup customer pricing system for vendors
async function setupCustomerPricingSystem() {
    if (!IS_VENDOR) return;
    
    try {
        // Load customers for the dropdown
        const response = await apiCall('/vendor/customers-dropdown');
        if (response.success) {
            const customerFilter = document.getElementById('customerFilterProducts');
            if (customerFilter) {
                customerFilter.innerHTML = '<option value="">Select Customer to Edit Pricing</option>' +
                    response.customers.map(customer => 
                        `<option value="${customer.customer_id}">${customer.company_name}</option>`
                    ).join('');
                
                // Handle customer selection change
                customerFilter.addEventListener('change', function() {
                    selectedCustomerId = this.value;
                    if (selectedCustomerId) {
                        loadCustomerPricing();
                        document.getElementById('noCustomerMessage').style.display = 'none';
                    } else {
                        document.getElementById('noCustomerMessage').style.display = 'block';
                        // Reset pricing displays
                        filteredProducts.forEach(product => {
                            updatePriceIndicator(product.product_id);
                        });
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error setting up customer pricing system:', error);
    }
}

async function loadCustomerPricing() {
    if (!selectedCustomerId || !IS_VENDOR) return;
    
    try {
        const response = await apiCall(`/customer-pricing/${selectedCustomerId}`);
        if (response.success) {
            customerPricing = {};
            response.pricing.forEach(item => {
                customerPricing[item.product_id] = item.custom_price;
            });
            
            // Update product displays with pricing
            updateProductPricing();
        }
    } catch (error) {
        console.error('Error loading customer pricing:', error);
    }
}

function updateProductPricing() {
    // Update pricing displays for vendor users
    filteredProducts.forEach(product => {
        updatePriceIndicator(product.product_id);
    });
}

function updatePriceIndicator(productId) {
    if (!IS_VENDOR) return;
    
    const priceSection = document.getElementById(`price-section-${productId}`);
    if (!priceSection) return;
    
    const product = currentProducts.find(p => p.product_id === productId);
    if (!product) return;
    
    const customPrice = customerPricing[productId];
    const basePrice = product.price || 0;
    
    if (customPrice !== undefined && selectedCustomerId) {
        priceSection.innerHTML = `
            <div class="product-price">
                Base: ‚Çπ${basePrice.toLocaleString('en-IN')} 
                <span style="color: var(--secondary-green); margin-left: 8px;">
                    Custom: ‚Çπ${customPrice.toLocaleString('en-IN')}
                </span>
            </div>
            <div class="product-gst">+ ${product.gst_rate || 18}% GST</div>
            <button class="btn btn-sm btn-warning" onclick="editCustomerPrice('${productId}', ${customPrice})" style="margin-top: 8px;">
                Edit ‚úçüèª
            </button>
        `;
    } else if (selectedCustomerId) {
        priceSection.innerHTML = `
            <div class="product-price">‚Çπ${basePrice.toLocaleString('en-IN')}</div>
            <div class="product-gst">+ ${product.gst_rate || 18}% GST</div>
            <button class="btn btn-sm btn-warning" onclick="setCustomerPrice('${productId}')" style="margin-top: 8px;">
                Set Price ‚úçüèª
            </button>
        `;
    } else {
        priceSection.innerHTML = `
            <div class="product-price">Base Price: ‚Çπ${basePrice.toLocaleString('en-IN')}</div>
            <div class="product-gst">+ ${product.gst_rate || 18}% GST</div>
        `;
    }
}

async function setCustomerPrice(productId) {
    if (!selectedCustomerId) {
        showNotification('Please select a customer first', 'warning');
        return;
    }
    
    const product = currentProducts.find(p => p.product_id === productId);
    if (!product) return;
    
    const customPrice = prompt(`Set custom price for ${product.product_name}\nBase price: ‚Çπ${product.price}`, product.price);
    
    if (customPrice !== null && !isNaN(customPrice) && parseFloat(customPrice) >= 0) {
        try {
            const response = await apiCall('/customer-pricing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    customer_id: selectedCustomerId,
                    product_id: productId,
                    custom_price: parseFloat(customPrice)
                })
            });
            
            if (response.success) {
                customerPricing[productId] = parseFloat(customPrice);
                updatePriceIndicator(productId);
                showNotification('Custom price set successfully', 'success');
            } else {
                showNotification(response.message || 'Failed to set custom price', 'error');
            }
        } catch (error) {
            console.error('Error setting custom price:', error);
            showNotification('Failed to set custom price', 'error');
        }
    }
}

async function editCustomerPrice(productId, currentPrice) {
    const product = currentProducts.find(p => p.product_id === productId);
    if (!product) return;
    
    const newPrice = prompt(`Edit custom price for ${product.product_name}\nCurrent custom price: ‚Çπ${currentPrice}`, currentPrice);
    
    if (newPrice !== null && !isNaN(newPrice) && parseFloat(newPrice) >= 0) {
        try {
            const response = await apiCall('/customer-pricing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    customer_id: selectedCustomerId,
                    product_id: productId,
                    custom_price: parseFloat(newPrice)
                })
            });
            
            if (response.success) {
                customerPricing[productId] = parseFloat(newPrice);
                updatePriceIndicator(productId);
                showNotification('Custom price updated successfully', 'success');
            } else {
                showNotification(response.message || 'Failed to update custom price', 'error');
            }
        } catch (error) {
            console.error('Error updating custom price:', error);
            showNotification('Failed to update custom price', 'error');
        }
    }
}

// Product Details Modal
async function viewProductDetails(productId) {
    try {
        const product = currentProducts.find(p => p.product_id === productId);
        if (!product) {
            showNotification('Product not found', 'error');
            return;
        }
        
        // Create and show modal
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Product Details</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 12px;">${product.product_name}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div><strong>Item Number:</strong> ${product.item_no}</div>
                            <div><strong>Category:</strong> ${product.category}</div>
                            ${product.product_make ? `<div><strong>Make:</strong> ${product.product_make}</div>` : ''}
                            ${product.product_model ? `<div><strong>Model:</strong> ${product.product_model}</div>` : ''}
                            <div><strong>Price:</strong> ‚Çπ${(product.price || 0).toLocaleString('en-IN')}</div>
                            <div><strong>Stock:</strong> ${product.quantity} units</div>
                            <div><strong>GST Rate:</strong> ${product.gst_rate || 18}%</div>
                            ${product.hsn_code ? `<div><strong>HSN Code:</strong> ${product.hsn_code}</div>` : ''}
                        </div>
                    </div>
                    
                    ${product.description ? `
                        <div style="margin-bottom: 20px;">
                            <h5>Description</h5>
                            <p style="color: var(--gray-700);">${product.description}</p>
                        </div>
                    ` : ''}
                    
                    ${IS_VENDOR && selectedCustomerId ? `
                        <div style="margin-bottom: 20px;">
                            <h5>Customer Pricing</h5>
                            <div id="modalPricing" style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
                                ${customerPricing[productId] ? 
                                    `Custom Price: ‚Çπ${customerPricing[productId].toLocaleString('en-IN')}` : 
                                    'No custom pricing set'}
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    ${IS_VENDOR ? `<button class="btn btn-primary" onclick="editProduct('${productId}'); this.closest('.modal').remove();">Edit Product</button>` : ''}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    } catch (error) {
        console.error('Error viewing product details:', error);
        showNotification('Failed to load product details', 'error');
    }
}

// Edit Product Modal
async function editProduct(productId) {
    try {
        const product = currentProducts.find(p => p.product_id === productId);
        if (!product) {
            showNotification('Product not found', 'error');
            return;
        }
        
        // Load fresh categories before creating edit modal
        await loadCategoriesForProductForm();
        
        // Create and show edit modal
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Product</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Product Name</label>
                                <input type="text" class="form-control" name="product_name" value="${product.product_name}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-control" name="category" required id="editCategorySelect">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Make</label>
                                <input type="text" class="form-control" name="product_make" value="${product.product_make || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" name="product_model" value="${product.product_model || ''}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3">${product.description || ''}</textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Base Price (‚Çπ)</label>
                                <input type="number" class="form-control" name="price" value="${product.price || 0}" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control" name="quantity" value="${product.quantity}" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">GST Rate (%)</label>
                                <select class="form-control" name="gst_rate">
                                    <option value="0" ${product.gst_rate === 0 ? 'selected' : ''}>0%</option>
                                    <option value="5" ${product.gst_rate === 5 ? 'selected' : ''}>5%</option>
                                    <option value="12" ${product.gst_rate === 12 ? 'selected' : ''}>12%</option>
                                    <option value="18" ${product.gst_rate === 18 ? 'selected' : ''}>18%</option>
                                    <option value="28" ${product.gst_rate === 28 ? 'selected' : ''}>28%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">HSN Code</label>
                                <input type="text" class="form-control" name="hsn_code" value="${product.hsn_code || ''}">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveProductChanges('${productId}', this.closest('.modal'))">Save Changes</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Populate category dropdown and select current category
        setTimeout(async () => {
            try {
                // Get categories again to populate the edit form
                let response = await apiCall('/products/categories');
                if (!response.success) {
                    response = await apiCall('/products/categories/simple');
                }
                
                if (response.success && response.categories) {
                    const editCategorySelect = document.getElementById('editCategorySelect');
                    if (editCategorySelect) {
                        editCategorySelect.innerHTML = '<option value="">Select Category</option>' +
                            response.categories.map(category => 
                                `<option value="${category}" ${category === product.category ? 'selected' : ''}>${category}</option>`
                            ).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading categories for edit form:', error);
            }
        }, 100);
        
    } catch (error) {
        console.error('Error editing product:', error);
        showNotification('Failed to load product editor', 'error');
    }
}

async function saveProductChanges(productId, modal) {
    try {
        const form = modal.querySelector('#editProductForm');
        const formData = new FormData(form);
        
        const updateData = {
            product_name: formData.get('product_name'),
            category: formData.get('category'),
            product_make: formData.get('product_make'),
            product_model: formData.get('product_model'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')) || 0,
            quantity: parseInt(formData.get('quantity')) || 0,
            gst_rate: parseFloat(formData.get('gst_rate')) || 18,
            hsn_code: formData.get('hsn_code')
        };
        
        const response = await apiCall(`/products/${productId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (response.success) {
            showNotification('Product updated successfully!', 'success');
            modal.remove();
            loadProducts(); // Reload products
        } else {
            showNotification(response.message || 'Failed to update product', 'error');
        }
    } catch (error) {
        console.error('Error saving product changes:', error);
        showNotification('Failed to update product', 'error');
    }
}

// Cart functions for customer users
function changeQuantity(productId, change) {
    if (!IS_CUSTOMER) return;
    
    const input = document.getElementById(`qty_${productId}`);
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, currentValue + change);
    const maxValue = parseInt(input.max) || 999;
    
    input.value = Math.min(newValue, maxValue);
}

function addToCart(productId) {
    if (!IS_CUSTOMER) return;
    
    console.log('Adding to cart:', productId);
    
    const product = currentProducts.find(p => p.product_id === productId);
    const quantityInput = document.getElementById(`qty_${productId}`);
    
    if (!product || !quantityInput) {
        showNotification('Error adding product to cart', 'error');
        return;
    }
    
    const quantity = parseInt(quantityInput.value) || 1;
    
    // Use custom price if available, otherwise use base price
    const price = product.custom_price || product.price || 0;
    
    if (price === 0) {
        showNotification('Product price not available', 'error');
        return;
    }
    
    // Check if product already in cart
    const existingItemIndex = cart.findIndex(item => item.product_id === productId);
    
    if (existingItemIndex >= 0) {
        cart[existingItemIndex].quantity += quantity;
        cart[existingItemIndex].total = cart[existingItemIndex].quantity * price;
    } else {
        cart.push({
            product_id: productId,
            product_name: product.product_name,
            price: price,
            quantity: quantity,
            total: price * quantity
        });
    }
    
    saveCart();
    updateCartDisplay();
    showNotification(`${product.product_name} added to cart!`, 'success');
    
    // Reset quantity to 1
    quantityInput.value = 1;
}

function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCartDisplay() {
    const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartTotal = cart.reduce((sum, item) => sum + item.total, 0);
    
    // Update cart badge in navigation
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        if (cartCount > 0) {
            cartBadge.textContent = cartCount;
            cartBadge.style.display = 'flex';
            cartBadge.style.animation = 'cartPulse 0.3s ease';
        } else {
            cartBadge.style.display = 'none';
        }
    }
    
    // Update other cart display elements if they exist
    const elements = [
        { id: 'cartCount', value: cartCount },
        { id: 'cartCountHeader', value: cartCount },
        { id: 'cartItemsText', value: `${cartCount} item${cartCount !== 1 ? 's' : ''} in cart` },
        { id: 'cartTotalText', value: `‚Çπ${cartTotal.toLocaleString('en-IN')}` }
    ];
    
    elements.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
    
    // Show/hide cart summary elements
    const viewCartBtn = document.getElementById('viewCartBtn');
    const cartSummary = document.getElementById('cartSummary');
    
    if (viewCartBtn) viewCartBtn.style.display = cartCount > 0 ? 'block' : 'none';
    if (cartSummary) cartSummary.classList.toggle('show', cartCount > 0);
    
    console.log(`Cart updated: ${cartCount} items, total: ‚Çπ${cartTotal.toLocaleString('en-IN')}`);
}

function loadCart() {
    if (!IS_CUSTOMER) return;
    
    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
        cart = JSON.parse(savedCart);
        updateCartDisplay();
    }
}

function viewCart() {
    window.location.href = '/orders?action=cart';
}

// Other helper functions
function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchProducts();
        }
    });
    
    ['categoryFilter', 'priceFilter', 'stockFilter', 'sortFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', searchProducts);
        }
    });
}

function populateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;
    
    const uniqueCategories = [...new Set(currentProducts.map(p => p.category))];
    
    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
        uniqueCategories.map(category => 
            `<option value="${category}">${category}</option>`
        ).join('');
    
    loadCategoriesForProductForm();
}

function searchProducts() {
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const priceRange = document.getElementById('priceFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    
    // Filter logic
    filteredProducts = currentProducts.filter(product => {
        // Search filter
        const matchesSearch = !searchTerm || 
            product.product_name.toLowerCase().includes(searchTerm) ||
            (product.product_make && product.product_make.toLowerCase().includes(searchTerm)) ||
            (product.product_model && product.product_model.toLowerCase().includes(searchTerm));
        
        // Category filter
        const matchesCategory = !category || product.category === category;
        
        // Price filter
        let matchesPrice = true;
        if (priceRange) {
            const price = product.custom_price || product.price || 0;
            if (priceRange === '0-100') matchesPrice = price < 100;
            else if (priceRange === '100-500') matchesPrice = price >= 100 && price < 500;
            else if (priceRange === '500-1000') matchesPrice = price >= 500 && price < 1000;
            else if (priceRange === '1000+') matchesPrice = price >= 1000;
        }
        
        return matchesSearch && matchesCategory && matchesPrice;
    });
    
    // Apply sorting
    if (sortBy === 'name_asc') {
        filteredProducts.sort((a, b) => a.product_name.localeCompare(b.product_name));
    } else if (sortBy === 'name_desc') {
        filteredProducts.sort((a, b) => b.product_name.localeCompare(a.product_name));
    } else if (sortBy === 'price_asc') {
        filteredProducts.sort((a, b) => (a.custom_price || a.price) - (b.custom_price || b.price));
    } else if (sortBy === 'price_desc') {
        filteredProducts.sort((a, b) => (b.custom_price || b.price) - (a.custom_price || a.price));
    } else if (sortBy === 'stock_asc') {
        filteredProducts.sort((a, b) => a.quantity - b.quantity);
    } else if (sortBy === 'stock_desc') {
        filteredProducts.sort((a, b) => b.quantity - a.quantity);
    }
    
    displayProducts();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('priceFilter').value = '';
    if (document.getElementById('stockFilter')) {
        document.getElementById('stockFilter').value = '';
    }
    document.getElementById('sortFilter').value = 'name_asc';
    
    searchProducts();
}

function showEmptyState(message = 'No products found') {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--gray-500);">
            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">
                <i class="fas fa-box"></i>
            </div>
            <h3>${message}</h3>
            <p>Products will appear here when available.</p>
        </div>
    `;
}

// Function to refresh categories in existing forms (useful for when categories are updated)
function refreshProductFormCategories() {
    console.log('Refreshing product form categories...');
    loadCategoriesForProductForm();
}

// Add Product Modal Functions (for vendors)
// Function to show the add product modal - THIS WAS MISSING!
function showAddProductModal() {
    const modal = document.getElementById('addProductModal');
    if (modal) {
        modal.classList.add('show');
        
        // Focus first field (now product name since item number is auto-generated)
        setTimeout(() => {
            const firstField = document.querySelector('#addProductModal [name="product_name"]');
            if (firstField) {
                firstField.focus();
            }
        }, 100);
        
        // Load fresh categories
        loadCategoriesForProductForm();
    }
}

function closeAddProductModal() {
    const modal = document.getElementById('addProductModal');
    if (modal) {
        modal.classList.remove('show');
        document.getElementById('addProductForm').reset();
        
        // Clear image preview if it exists
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
            imagePreview.style.display = 'none';
            imagePreview.innerHTML = '';
        }
        
        // Reset any error messages
        const errorSpans = document.querySelectorAll('#addProductForm .form-error');
        errorSpans.forEach(span => {
            span.textContent = '';
        });
    }
}

// Enhanced submitAddProduct function with category validation
async function submitAddProduct() {
    const form = document.getElementById('addProductForm');
    const formData = new FormData(form);
    
    // Validate that a category is selected
    const selectedCategory = formData.get('category');
    if (!selectedCategory) {
        showNotification('Please select a category for the product', 'error');
        return;
    }
    
    // Remove item_no from formData since it will be auto-generated
    formData.delete('item_no');
    
    try {
        const response = await fetch('/api/products', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Product created successfully! Item Number: ${result.item_no}`, 'success');
            closeAddProductModal();
            loadProducts(); // This will also refresh categories
        } else {
            showNotification(result.message || 'Failed to create product', 'error');
        }
    } catch (error) {
        console.error('Error creating product:', error);
        showNotification('Failed to create product', 'error');
    }
}

async function loadCategoriesForProductForm() {
    try {
        console.log('Loading categories for product form...');
        
        // Try main endpoint first
        let response = await apiCall('/products/categories');
        
        // If that fails, try the simple endpoint
        if (!response.success) {
            console.log('Main categories endpoint failed, trying simple endpoint...');
            response = await apiCall('/products/categories/simple');
        }
        
        if (response.success && response.categories) {
            console.log('Categories loaded:', response.categories);
            populateProductCategoryDropdowns(response.categories);
        } else {
            console.error('Failed to load categories:', response);
            // Use fallback categories
            const fallbackCategories = [
                'Office Stationery',
                'Computer Accessories',
                'Furniture',
                'Office Equipment',
                'Printing Supplies',
                'Storage & Organization',
                'Cleaning Supplies',
                'Safety Equipment',
                'Communication Equipment',
                'Miscellaneous'
            ];
            populateProductCategoryDropdowns(fallbackCategories);
        }
    } catch (error) {
        console.error('Error loading categories for product form:', error);
        // Use fallback categories
        const fallbackCategories = [
            'Office Stationery',
            'Computer Accessories',
            'Furniture',
            'Office Equipment',
            'Printing Supplies',
            'Storage & Organization',
            'Cleaning Supplies',
            'Safety Equipment',
            'Communication Equipment',
            'Miscellaneous'
        ];
        populateProductCategoryDropdowns(fallbackCategories);
    }
}

// Function to populate category dropdowns in product forms
function populateProductCategoryDropdowns(categories) {
    // Add Product Modal category dropdown
    const addProductCategorySelect = document.querySelector('#addProductModal [name="category"]');
    if (addProductCategorySelect) {
        addProductCategorySelect.innerHTML = '<option value="">Select Category</option>' +
            categories.map(category => `<option value="${category}">${category}</option>`).join('');
        console.log('Populated add product category dropdown with', categories.length, 'categories');
    }
    
    // Edit Product Modal category dropdown (if it exists)
    const editProductCategorySelect = document.querySelector('#editProductModal [name="category"]');
    if (editProductCategorySelect) {
        editProductCategorySelect.innerHTML = '<option value="">Select Category</option>' +
            categories.map(category => `<option value="${category}">${category}</option>`).join('');
        console.log('Populated edit product category dropdown with', categories.length, 'categories');
    }
    
    // Category filter dropdown
    const categoryFilter = document.getElementById('categoryFilter');
    if (categoryFilter) {
        const currentValue = categoryFilter.value; // Preserve current selection
        categoryFilter.innerHTML = '<option value="">All Categories</option>' +
            categories.map(category => `<option value="${category}">${category}</option>`).join('');
        
        // Restore previous selection if it still exists
        if (currentValue && categories.includes(currentValue)) {
            categoryFilter.value = currentValue;
        }
        console.log('Populated category filter dropdown with', categories.length, 'categories');
    }
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    const errorSpan = document.getElementById('imageError');
    
    if (!file) {
        preview.style.display = 'none';
        return;
    }
    
    // Validate file size (16MB max)
    if (file.size > 16 * 1024 * 1024) {
        errorSpan.textContent = 'File size must be less than 16MB';
        event.target.value = '';
        preview.style.display = 'none';
        return;
    }
    
    // Clear any errors
    errorSpan.textContent = '';
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
        preview.innerHTML = `
            <img src="${e.target.result}" 
                 style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px;">
            <div style="margin-top: 8px; font-size: 0.875rem; color: var(--gray-600);">
                Preview: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
            </div>
        `;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// Add a manual refresh button function (you can add this button to your UI if needed)
function manualRefreshCategories() {
    console.log('Manually refreshing categories...');
    loadCategoriesForProductForm();
    showNotification('Categories refreshed!', 'success');
}

</script>
{% endblock %}