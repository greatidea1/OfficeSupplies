{% extends "base.html" %}

{% block title %}Products - Office Supplies System{% endblock %}

{% block extra_css %}
<style>

    /* Placeholder for missing product images */
    .product-image-placeholder {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
        font-size: 48px;
        border: 1px solid var(--gray-200);
    }

    .product-image-placeholder i {
        opacity: 0.5;
    }

    /* Modal improvements */
    .modal-content {
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @media (max-width: 768px) {
        .modal-body > div:first-child {
            grid-template-columns: 1fr !important;
            gap: 16px !important;
        }
        
        .product-card {
            padding: 16px;
        }
    }

    .products-container {
        padding: 32px 0;
    }
    
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
    }
    
    .filters-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        margin-bottom: 32px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-label {
        font-weight: 500;
        color: var(--gray-700);
        font-size: 0.875rem;
    }
    
    .search-section {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 12px 16px;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }
    
    .product-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: fit-content;
    }
    
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-blue);
    }

    .product-card img {
        transition: transform 0.3s ease;
    }
    
    .product-card:hover img {
        transform: scale(1.02);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }
    
    .product-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .product-category {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-bottom: 8px;
    }
    
    .product-details {
        margin-bottom: 16px;
    }
    
    .product-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }
    
    .product-info-label {
        color: var(--gray-600);
    }
    
    .product-info-value {
        font-weight: 500;
        color: var(--gray-900);
    }
    
    /* Updated pricing styles for editable rates */
    .product-price-section {
        margin-bottom: 16px;
        padding: 12px;
        background: var(--gray-50);
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .product-price-section.editable {
        border-color: var(--primary-blue);
        background: rgba(37, 99, 235, 0.05);
    }
    
    .product-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .price-input {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        background: none;
        border: none;
        outline: none;
        width: 120px;
        padding: 2px;
        border-bottom: 2px solid var(--primary-blue);
    }
    
    .price-actions {
        display: none;
        gap: 4px;
        margin-left: auto;
    }
    
    .product-price-section.editing .price-actions {
        display: flex;
    }
    
    .price-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .price-btn.save {
        background: var(--secondary-green);
        color: white;
    }
    
    .price-btn.cancel {
        background: var(--gray-400);
        color: white;
    }
    
    .price-btn:hover {
        transform: scale(1.1);
    }
    
    .base-price-indicator {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: normal;
        margin-top: 2px;
    }
    
    .custom-price-indicator {
        font-size: 0.75rem;
        color: var(--secondary-green);
        font-weight: 500;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .product-gst {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 8px;
    }
    
    .no-customer-message {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        color: var(--secondary-orange);
        text-align: center;
        font-weight: 500;
    }
    
    .product-stock {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .stock-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .stock-high {
        background: var(--secondary-green);
    }
    
    .stock-medium {
        background: var(--secondary-orange);
    }
    
    .stock-low {
        background: var(--secondary-red);
    }
    
    .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
    }
    
    .btn-add-cart {
        flex: 1;
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-add-cart:hover {
        background: var(--primary-blue-dark);
        transform: translateY(-1px);
    }
    
    .btn-add-cart:disabled {
        background: var(--gray-300) !important;
        cursor: not-allowed;
        transform: none !important;
    }

    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .quantity-input {
        width: 60px;
        padding: 8px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        text-align: center;
    }
    
    .quantity-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--gray-300);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
        background: var(--gray-50);
        border-color: var(--primary-blue);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-500);
        background: white;
        border-radius: 16px;
        border: 1px solid var(--gray-200);
        grid-column: 1 / -1;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .cart-summary {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        min-width: 200px;
        z-index: 100;
        display: none;
    }
    
    .cart-summary.show {
        display: block;
        animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .cart-items-count {
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 8px;
    }
    
    .cart-total {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 12px;
    }
    
    @media (max-width: 768px) {
        .products-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .search-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-input {
            min-width: auto;
        }
        
        .cart-summary {
            position: relative;
            bottom: auto;
            right: auto;
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="products-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    {% if current_user.role.startswith('vendor_') %}
                        Product Management
                    {% else %}
                        Product Catalog
                    {% endif %}
                </h1>
                <p style="color: var(--gray-600); margin: 8px 0 0 0;">
                    {% if current_user.role.startswith('vendor_') %}
                        Manage your product inventory and customer-specific pricing
                    {% else %}
                        Browse and order office supplies
                    {% endif %}
                </p>
            </div>
            <div style="display: flex; gap: 12px;">
                {% if current_user.role == 'customer_employee' %}
                <button class="btn btn-secondary" onclick="viewCart()" id="viewCartBtn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    View Cart (<span id="cartCount">0</span>)
                </button>
                {% endif %}
                {% if current_user.role.startswith('vendor_') %}
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Customer Selection Message for Vendors -->
        {% if current_user.role.startswith('vendor_') %}
        <div class="no-customer-message" id="noCustomerMessage">
            <i class="fas fa-info-circle"></i>
            Select a customer from the dropdown below to view and edit customer-specific pricing
        </div>
        {% endif %}
        
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                {% if current_user.role.startswith('vendor_') %}
                <div class="filter-group">
                    <label class="filter-label">Customer</label>
                    <select class="form-control" id="customerFilterProducts">
                        <option value="">Select Customer for Pricing</option>
                    </select>
                </div>
                {% endif %}
                
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="form-control" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Price Range</label>
                    <select class="form-control" id="priceFilter">
                        <option value="">All Prices</option>
                        <option value="0-100">₹0 - ₹100</option>
                        <option value="100-500">₹100 - ₹500</option>
                        <option value="500-1000">₹500 - ₹1,000</option>
                        <option value="1000+">₹1,000+</option>
                    </select>
                </div>
                
                {% if current_user.role.startswith('vendor_') %}
                <div class="filter-group">
                    <label class="filter-label">Stock Status</label>
                    <select class="form-control" id="stockFilter">
                        <option value="">All Stock</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                {% endif %}
                
                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select class="form-control" id="sortFilter">
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="price_asc">Price (Low to High)</option>
                        <option value="price_desc">Price (High to Low)</option>
                        {% if current_user.role.startswith('vendor_') %}
                        <option value="stock_asc">Stock (Low to High)</option>
                        <option value="stock_desc">Stock (High to Low)</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            
            <div class="search-section">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search products by name, make, model..."
                >
                <button class="btn btn-primary" onclick="searchProducts()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <!-- Products will be loaded here -->
            <div style="grid-column: 1 / -1; padding: 40px; text-align: center;">
                <div class="spinner"></div>
                Loading products...
            </div>
        </div>
    </div>
</div>

<!-- Cart Summary (for customers) -->
{% if current_user.role == 'customer_employee' %}
<div class="cart-summary" id="cartSummary">
    <div class="cart-items-count" id="cartItemsText">0 items in cart</div>
    <div class="cart-total" id="cartTotalText">₹0.00</div>
    <button class="btn btn-primary btn-sm" onclick="viewCart()">
        <i class="fas fa-shopping-cart"></i>
        View Cart
    </button>
</div>
{% endif %}

<!-- Add Product Modal (for vendors) - UPDATED WITHOUT RATE FIELD -->
{% if current_user.role.startswith('vendor_') %}
<div class="modal" id="addProductModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Add New Product</h3>
            <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" enctype="multipart/form-data">
                <!-- Basic Product Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Item Number <span style="color: var(--secondary-red);">*</span></label>
                        <input type="text" class="form-control" name="item_no" id="productItemNo" required>
                        <span class="form-help">Unique identifier for the product</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category <span style="color: var(--secondary-red);">*</span></label>
                        <select class="form-control" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Office Stationery">Office Stationery</option>
                            <option value="Computer Accessories">Computer Accessories</option>
                            <option value="Furniture">Furniture</option>
                            <option value="Office Equipment">Office Equipment</option>
                            <option value="Printing Supplies">Printing Supplies</option>
                            <option value="Storage & Organization">Storage & Organization</option>
                            <option value="Cleaning Supplies">Cleaning Supplies</option>
                            <option value="Safety Equipment">Safety Equipment</option>
                            <option value="Communication Equipment">Communication Equipment</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Product Name <span style="color: var(--secondary-red);">*</span></label>
                    <input type="text" class="form-control" name="product_name" required>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Make/Manufacturer</label>
                        <input type="text" class="form-control" name="product_make">
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="product_model">
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description/Details</label>
                    <textarea class="form-control" name="description" rows="3" placeholder="Product description, features, specifications..."></textarea>
                    <span class="form-error"></span>
                </div>
                
                <!-- Stock Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Quantity <span style="color: var(--secondary-red);">*</span></label>
                        <input type="number" class="form-control" name="quantity" min="0" required>
                        <span class="form-help">Number of units in stock</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" class="form-control" name="low_stock_threshold" value="10" min="0">
                        <span class="form-help">Alert when stock falls below this number</span>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <!-- Note about pricing -->
                <div class="form-group">
                    <div style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3); border-radius: 8px; padding: 16px; color: var(--primary-blue);">
                        <i class="fas fa-info-circle"></i>
                        <strong>Pricing:</strong> After creating the product, set customer-specific pricing using the pricing editor on the products page.
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">GST Rate (%)</label>
                    <select class="form-control" name="gst_rate">
                        <option value="0">0% (Exempt)</option>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18" selected>18%</option>
                        <option value="28">28%</option>
                    </select>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">HSN Code</label>
                    <input type="text" class="form-control" name="hsn_code" placeholder="e.g., 84713000">
                    <span class="form-help">Harmonized System of Nomenclature code for tax classification</span>
                    <span class="form-error"></span>
                </div>
                
                <!-- Product Image Upload -->
                <div class="form-group">
                    <label class="form-label">Product Image</label>
                    <input type="file" class="form-control" name="product_image" accept="image/jpeg,image/jpg,image/png,image/gif" onchange="handleImageUpload(event)">
                    <span class="form-help">Upload product image (JPG, PNG, GIF - max 10MB). Images will be automatically resized to 800x800 pixels.</span>
                    <span class="form-error" id="imageError"></span>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" style="margin-top: 12px; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; display: none;">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitAddProduct()">
                <i class="fas fa-plus"></i>
                Create Product
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    let currentProducts = [];
    let filteredProducts = [];
    let categories = [];
    let cart = [];
    let selectedCustomerId = null;
    let customerPricing = {};
    
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        setupEventListeners();
        
        {% if current_user.role == 'customer_employee' %}
        loadCart();
        {% elif current_user.role.startswith('vendor_') %}
        setupCustomerPricingSystem();
        {% endif %}
    });
    
    function setupEventListeners() {
        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });
        
        // Auto-search on filter changes
        ['categoryFilter', 'priceFilter', 'stockFilter', 'sortFilter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', searchProducts);
            }
        });
    }
    
    {% if current_user.role.startswith('vendor_') %}
    function setupCustomerPricingSystem() {
        // Load customers for the pricing filter
        loadCustomersForPricing();
        
        // Listen for customer selection changes
        const customerFilter = document.getElementById('customerFilterProducts');
        if (customerFilter) {
            customerFilter.addEventListener('change', function(e) {
                selectedCustomerId = e.target.value;
                loadCustomerPricing();
                updateCustomerMessage();
                displayProducts(); // Refresh product display
            });
        }
    }
    
    async function loadCustomersForPricing() {
        try {
            const response = await apiCall('/vendor/customers-dropdown');
            if (response.success) {
                const customerFilter = document.getElementById('customerFilterProducts');
                customerFilter.innerHTML = '<option value="">Select Customer for Pricing</option>';
                
                response.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = customer.company_name;
                    customerFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading customers:', error);
        }
    }
    
    function updateCustomerMessage() {
        const messageEl = document.getElementById('noCustomerMessage');
        if (selectedCustomerId) {
            messageEl.style.display = 'none';
        } else {
            messageEl.style.display = 'block';
        }
    }
    
    async function loadCustomerPricing() {
        if (!selectedCustomerId) {
            customerPricing = {};
            return;
        }
        
        try {
            const response = await apiCall(`/customer-pricing/${selectedCustomerId}`);
            if (response.success) {
                customerPricing = {};
                response.pricing.forEach(item => {
                    customerPricing[item.product_id] = item.custom_price;
                });
                console.log('Loaded customer pricing:', customerPricing);
                // Refresh product display to show correct pricing
                displayProducts();
            }
        } catch (error) {
            console.error('Error loading customer pricing:', error);
            customerPricing = {};
        }
    }
    
    function getProductPrice(product) {
        if (selectedCustomerId && customerPricing[product.product_id]) {
            return customerPricing[product.product_id];
        }
        return product.price;
    }
    
    function hasCustomPrice(productId) {
        return selectedCustomerId && customerPricing[productId] !== undefined;
    }
    
    async function updateCustomerPrice(productId, newPrice) {
        if (!selectedCustomerId) {
            showNotification('Please select a customer first', 'error');
            return false;
        }
        
        try {
            const response = await apiCall('/customer-pricing', {
                method: 'POST',
                body: JSON.stringify({
                    customer_id: selectedCustomerId,
                    product_id: productId,
                    custom_price: parseFloat(newPrice)
                })
            });
            
            if (response.success) {
                customerPricing[productId] = parseFloat(newPrice);
                showNotification('Price updated successfully!', 'success');
                return true;
            } else {
                showNotification(response.message || 'Failed to update price', 'error');
                return false;
            }
        } catch (error) {
            console.error('Error updating customer price:', error);
            showNotification('Failed to update price', 'error');
            return false;
        }
    }
    
    function startPriceEdit(productId) {
        const priceSection = document.getElementById(`price-section-${productId}`);
        const priceDisplay = document.getElementById(`price-display-${productId}`);
        const priceInput = document.getElementById(`price-input-${productId}`);
        
        const currentPrice = getProductPrice(currentProducts.find(p => p.product_id === productId));
        
        priceSection.classList.add('editing');
        priceDisplay.style.display = 'none';
        priceInput.style.display = 'inline';
        priceInput.value = currentPrice;
        priceInput.focus();
        priceInput.select();
    }
    
    async function savePriceEdit(productId) {
        const priceSection = document.getElementById(`price-section-${productId}`);
        const priceDisplay = document.getElementById(`price-display-${productId}`);
        const priceInput = document.getElementById(`price-input-${productId}`);
        
        const newPrice = parseFloat(priceInput.value);
        
        if (isNaN(newPrice) || newPrice < 0) {
            showNotification('Please enter a valid price', 'error');
            return;
        }
        
        const success = await updateCustomerPrice(productId, newPrice);
        
        if (success) {
            priceDisplay.textContent = `₹${newPrice.toLocaleString('en-IN')}`;
            updatePriceIndicator(productId);
            updateGSTDisplay(productId);
        }
        
        cancelPriceEdit(productId);
    }
    
    function cancelPriceEdit(productId) {
        const priceSection = document.getElementById(`price-section-${productId}`);
        const priceDisplay = document.getElementById(`price-display-${productId}`);
        const priceInput = document.getElementById(`price-input-${productId}`);
        
        priceSection.classList.remove('editing');
        priceDisplay.style.display = 'inline';
        priceInput.style.display = 'none';
    }
    
    function updatePriceIndicator(productId) {
        const indicator = document.getElementById(`price-indicator-${productId}`);
        if (hasCustomPrice(productId)) {
            indicator.className = 'custom-price-indicator';
            indicator.innerHTML = '<i class="fas fa-tag"></i> Custom Price';
        } else {
            indicator.className = 'base-price-indicator';
            indicator.textContent = 'Base Price';
        }
    }
    
    function updateGSTDisplay(productId) {
        const product = currentProducts.find(p => p.product_id === productId);
        const currentPrice = getProductPrice(product);
        const gstAmount = (currentPrice * product.gst_rate) / 100;
        
        const gstDisplay = document.getElementById(`gst-display-${productId}`);
        if (gstDisplay) {
            gstDisplay.textContent = `+ ₹${gstAmount.toFixed(2)} GST (${product.gst_rate}%)`;
        }
    }
    {% endif %}
    
    async function loadProducts() {
        try {
            const response = await apiCall('/products');
            const grid = document.getElementById('productsGrid');
            
            if (response.success && response.products) {
                currentProducts = response.products;
                filteredProducts = [...currentProducts];
                categories = response.categories || [];
                
                populateCategoryFilter();
                
                {% if current_user.role.startswith('vendor_') %}
                await loadCustomerPricing();
                {% endif %}
                
                displayProducts();
            } else {
                console.error('API returned error or no products:', response);
                showEmptyState('No products available');
            }
        } catch (error) {
            console.error('Error loading products:', error);
            showEmptyState('Error loading products');
        }
    }
    
    function populateCategoryFilter() {
        const categoryFilter = document.getElementById('categoryFilter');
        const uniqueCategories = [...new Set(currentProducts.map(p => p.category))];
        
        categoryFilter.innerHTML = '<option value="">All Categories</option>' +
            uniqueCategories.map(category => 
                `<option value="${category}">${category}</option>`
            ).join('');
    }
    
    function displayProducts() {
        const grid = document.getElementById('productsGrid');
        
        if (filteredProducts.length === 0) {
            showEmptyState('No products found');
            return;
        }
        
        {% if current_user.role == 'customer_employee' or current_user.role == 'customer_hr_admin' or current_user.role == 'customer_dept_head' %}
        // Customer view with images and modal
        console.log('Displaying products for customer user');
        const currentUserRole = '{{ current_user.role }}'; // Get role from template
        
        grid.innerHTML = filteredProducts.map(product => {
            const isOutOfStock = product.quantity === 0;
            // Use custom_price if available, otherwise use base price, default to 0 if neither
            const effectivePrice = product.custom_price || product.price || 0;
            const gstAmount = (effectivePrice * (product.gst_rate || 18)) / 100;
            const productImage = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0] : '';
            
            // Don't show products with 0 price unless they have custom pricing
            if (effectivePrice === 0 && !product.custom_price) {
                return ''; // Skip products without pricing
            }
            
            return `
                <div class="product-card" onclick="viewProductDetails('${product.product_id}')" style="cursor: pointer;">
                    <!-- Product Name -->
                    <div class="product-name" style="text-align: left; margin-bottom: 16px; font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">
                        ${product.product_name}
                    </div>
                    
                    <!-- Product Image -->
                    <div style="text-align: center; margin-bottom: 16px;">
                        ${productImage ? `
                            <img src="${productImage}" 
                                 alt="${product.product_name}" 
                                 style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="product-image-placeholder" style="display: none; width: 100%; height: 200px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                                <i class="fas fa-box"></i>
                            </div>
                        ` : `
                            <div class="product-image-placeholder" style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                                <i class="fas fa-box"></i>
                            </div>
                        `}
                    </div>
                    
                    <!-- Product Details -->
                    <div class="product-details" style="margin-bottom: 16px;">
                        ${product.product_make ? `
                            <div class="product-info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--gray-600); font-size: 0.875rem;">Make:</span>
                                <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.product_make}</span>
                            </div>
                        ` : ''}
                        
                        ${product.product_model ? `
                            <div class="product-info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--gray-600); font-size: 0.875rem;">Model:</span>
                                <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.product_model}</span>
                            </div>
                        ` : ''}
                        
                        <div class="product-info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Category:</span>
                            <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.category}</span>
                        </div>
                        
                        <div class="product-info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Item No:</span>
                            <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.item_no}</span>
                        </div>
                    </div>
                    
                    <!-- Price Section -->
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 4px;">
                            ₹${effectivePrice.toLocaleString('en-IN')}
                            ${product.custom_price ? '<span style="font-size: 0.75rem; color: var(--secondary-green); margin-left: 8px;">Special Price</span>' : ''}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">
                            + ₹${gstAmount.toFixed(2)} GST (${product.gst_rate || 18}%)
                        </div>
                    </div>
                    
                    <!-- Action Section - Only for employees -->
                    ${currentUserRole === 'customer_employee' ? `
                    <div onclick="event.stopPropagation()" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <!-- Quantity Controls -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="quantity-btn" onclick="changeQuantity('${product.product_id}', -1)" ${isOutOfStock ? 'disabled' : ''} style="width: 32px; height: 32px; border: 1px solid var(--gray-300); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="quantity-input" id="qty_${product.product_id}" value="1" min="1" max="${product.quantity}" ${isOutOfStock ? 'disabled' : ''} style="width: 60px; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px; text-align: center;">
                            <button class="quantity-btn" onclick="changeQuantity('${product.product_id}', 1)" ${isOutOfStock ? 'disabled' : ''} style="width: 32px; height: 32px; border: 1px solid var(--gray-300); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <!-- Add to Cart Button -->
                        <button class="btn-add-cart" onclick="addToCart('${product.product_id}')" ${isOutOfStock ? 'disabled' : ''} data-price="${effectivePrice}" style="flex: 1; background: var(--primary-blue); color: white; border: none; padding: 12px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-shopping-cart"></i>
                            ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }).filter(card => card !== '').join(''); // Filter out empty cards
        
        {% else %}
        // Vendor view with pricing controls
        console.log('Displaying products for vendor user');
        grid.innerHTML = filteredProducts.map(product => `
            <div class="product-card">
                <div class="product-header">
                    <div>
                        <div class="product-category">${product.category}</div>
                        <div class="product-name">${product.product_name}</div>
                    </div>
                    ${getStockIndicator(product)}
                </div>
                
                <div class="product-details">
                    ${product.product_make ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Make:</span>
                            <span class="product-info-value">${product.product_make}</span>
                        </div>
                    ` : ''}
                    ${product.product_model ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Model:</span>
                            <span class="product-info-value">${product.product_model}</span>
                        </div>
                    ` : ''}
                    <div class="product-info-row">
                        <span class="product-info-label">Item No:</span>
                        <span class="product-info-value">${product.item_no}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Stock:</span>
                        <span class="product-info-value">${product.quantity} units</span>
                    </div>
                </div>
                
                ${getPriceSection(product)}
                ${getProductActions(product)}
            </div>
        `).join('');
        
        // Update all price indicators after display for vendor users only
        if (typeof updatePriceIndicator === 'function') {
            filteredProducts.forEach(product => {
                updatePriceIndicator(product.product_id);
            });
        }
        {% endif %}
        
        // If no products to show after filtering, show empty state
        if (grid.innerHTML.trim() === '') {
            showEmptyState('No products available with pricing');
        }
        
        console.log('Products displayed successfully');
    }

    function getVendorProductCard(product) {
        // Keep existing vendor card logic
        return `
            <div class="product-card">
                <div class="product-header">
                    <div>
                        <div class="product-category">${product.category}</div>
                        <div class="product-name">${product.product_name}</div>
                    </div>
                    ${getStockIndicator(product)}
                </div>
                
                <div class="product-details">
                    ${product.product_make ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Make:</span>
                            <span class="product-info-value">${product.product_make}</span>
                        </div>
                    ` : ''}
                    ${product.product_model ? `
                        <div class="product-info-row">
                            <span class="product-info-label">Model:</span>
                            <span class="product-info-value">${product.product_model}</span>
                        </div>
                    ` : ''}
                    <div class="product-info-row">
                        <span class="product-info-label">Item No:</span>
                        <span class="product-info-value">${product.item_no}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Stock:</span>
                        <span class="product-info-value">${product.quantity} units</span>
                    </div>
                </div>
                
                ${getPriceSection(product)}
                ${getProductActions(product)}
            </div>
        `;
    }

    // Product Details Modal
    function viewProductDetails(productId) {
        const product = currentProducts.find(p => p.product_id === productId);
        if (!product) return;
        
        const effectivePrice = product.custom_price || product.price;
        const gstAmount = (effectivePrice * product.gst_rate) / 100;
        const totalPrice = effectivePrice + gstAmount;
        const productImage = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0] : '';
        
        // Create modal if it doesn't exist
        let modal = document.getElementById('productDetailsModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'productDetailsModal';
            modal.className = 'modal';
            document.body.appendChild(modal);
        }
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 class="modal-title">${product.product_name}</h3>
                    <button class="modal-close" onclick="closeProductDetailsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Product Image -->
                        <div style="text-align: center;">
                            ${productImage ? `
                                <img src="${productImage}" 
                                     alt="${product.product_name}" 
                                     style="max-width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; border: 1px solid var(--gray-200);"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="product-image-placeholder" style="display: none; max-width: 100%; height: 300px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 12px; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                                    <i class="fas fa-box"></i>
                                </div>
                            ` : `
                                <div class="product-image-placeholder" style="width: 100%; height: 300px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                                    <i class="fas fa-box"></i>
                                </div>
                            `}
                        </div>
                        
                        <!-- Product Info -->
                        <div>
                            <h4 style="margin-bottom: 16px; color: var(--gray-900);">Product Information</h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div><strong>Category:</strong> ${product.category}</div>
                                ${product.product_make ? `<div><strong>Make:</strong> ${product.product_make}</div>` : ''}
                                ${product.product_model ? `<div><strong>Model:</strong> ${product.product_model}</div>` : ''}
                                <div><strong>Item Number:</strong> ${product.item_no}</div>
                                ${product.hsn_code ? `<div><strong>HSN Code:</strong> ${product.hsn_code}</div>` : ''}
                                <div><strong>GST Rate:</strong> ${product.gst_rate}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    ${product.description ? `
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin-bottom: 12px; color: var(--gray-900);">Description</h4>
                            <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; line-height: 1.6;">
                                ${product.description}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Pricing -->
                    <div style="background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark)); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">
                            ₹${effectivePrice.toLocaleString('en-IN')}
                        </div>
                        <div style="opacity: 0.9; margin-bottom: 12px;">
                            + ₹${gstAmount.toFixed(2)} GST (${product.gst_rate}%)
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 600; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 12px;">
                            Total: ₹${totalPrice.toFixed(2)}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeProductDetailsModal()">Close</button>
                    {% if current_user.role == 'customer_employee' %}
                    <button class="btn btn-primary" onclick="addToCartFromModal('${product.product_id}')">
                        <i class="fas fa-shopping-cart"></i>
                        Add to Cart
                    </button>
                    {% endif %}
                </div>
            </div>
        `;
        
        modal.classList.add('show');
    }

    function closeProductDetailsModal() {
        const modal = document.getElementById('productDetailsModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }

    {% if current_user.role == 'customer_employee' %}
    function addToCartFromModal(productId) {
        // Use quantity of 1 from modal
        const product = currentProducts.find(p => p.product_id === productId);
        if (!product) return;
        
        const price = product.custom_price || product.price;
        
        // Check if product already in cart
        const existingItemIndex = cart.findIndex(item => item.product_id === productId);
        
        if (existingItemIndex >= 0) {
            cart[existingItemIndex].quantity += 1;
            cart[existingItemIndex].total = cart[existingItemIndex].quantity * price;
        } else {
            cart.push({
                product_id: productId,
                product_name: product.product_name,
                price: price,
                quantity: 1,
                total: price
            });
        }
        
        saveCart();
        updateCartDisplay();
        showNotification(`${product.product_name} added to cart!`, 'success');
        closeProductDetailsModal();
    }
    {% endif %}
    
    function getPriceSection(product) {
        {% if current_user.role.startswith('vendor_') %}
        const currentPrice = getProductPrice(product);
        const gstAmount = (currentPrice * product.gst_rate) / 100;
        const isEditable = selectedCustomerId ? 'editable' : '';
        const clickHandler = selectedCustomerId ? `onclick="startPriceEdit('${product.product_id}')"` : '';
        
        return `
            <div class="product-price-section ${isEditable}" id="price-section-${product.product_id}">
                <div class="product-price" ${clickHandler}>
                    <span id="price-display-${product.product_id}">₹${currentPrice.toLocaleString('en-IN')}</span>
                    <input type="number" 
                           class="price-input" 
                           id="price-input-${product.product_id}" 
                           style="display: none;"
                           step="0.01"
                           min="0"
                           onkeypress="if(event.key==='Enter') savePriceEdit('${product.product_id}'); if(event.key==='Escape') cancelPriceEdit('${product.product_id}');">
                    <div class="price-actions">
                        <button class="price-btn save" onclick="savePriceEdit('${product.product_id}')" title="Save">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="price-btn cancel" onclick="cancelPriceEdit('${product.product_id}')" title="Cancel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${selectedCustomerId ? '<i class="fas fa-edit" style="font-size: 14px; margin-left: auto; opacity: 0.7;"></i>' : ''}
                </div>
                <div id="price-indicator-${product.product_id}" class="base-price-indicator">Base Price</div>
                <div class="product-gst" id="gst-display-${product.product_id}">+ ₹${gstAmount.toFixed(2)} GST (${product.gst_rate}%)</div>
            </div>
        `;
        {% else %}
        // For customer users, show their custom price or base price
        const price = product.custom_price || product.price;
        const gstAmount = (price * product.gst_rate) / 100;
        
        return `
            <div class="product-price-section">
                <div class="product-price">₹${price.toLocaleString('en-IN')}</div>
                <div class="product-gst">+ ₹${gstAmount.toFixed(2)} GST (${product.gst_rate}%)</div>
            </div>
        `;
        {% endif %}
    }
    
    function getStockIndicator(product) {
        {% if current_user.role.startswith('vendor_') %}
        const stockLevel = product.quantity;
        const threshold = product.low_stock_threshold || 10;
        
        let indicatorClass = 'stock-high';
        let stockText = 'In Stock';
        
        if (stockLevel === 0) {
            indicatorClass = 'stock-low';
            stockText = 'Out of Stock';
        } else if (stockLevel <= threshold) {
            indicatorClass = 'stock-medium';
            stockText = 'Low Stock';
        }
        
        return `
            <div class="product-stock">
                <div class="stock-indicator ${indicatorClass}"></div>
                <span style="font-size: 0.875rem; color: var(--gray-600);">${stockText}</span>
            </div>
        `;
        {% else %}
        return '';
        {% endif %}
    }
    
    function getProductActions(product) {
        {% if current_user.role == 'customer_employee' %}
        const isOutOfStock = product.quantity === 0;
        const effectivePrice = product.custom_price || product.price;
        
        return `
            <div class="quantity-selector">
                <button class="quantity-btn" onclick="changeQuantity('${product.product_id}', -1)" ${isOutOfStock ? 'disabled' : ''}>
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" class="quantity-input" id="qty_${product.product_id}" value="1" min="1" max="${product.quantity}" ${isOutOfStock ? 'disabled' : ''}>
                <button class="quantity-btn" onclick="changeQuantity('${product.product_id}', 1)" ${isOutOfStock ? 'disabled' : ''}>
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="product-actions">
                <button class="btn-add-cart" onclick="addToCart('${product.product_id}')" ${isOutOfStock ? 'disabled' : ''} data-price="${effectivePrice}">
                    <i class="fas fa-shopping-cart"></i>
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
            </div>
        `;
        {% elif current_user.role.startswith('vendor_') %}
        return `
            <div class="product-actions">
                <button class="btn btn-secondary btn-sm" onclick="editProduct('${product.product_id}')">
                    <i class="fas fa-edit"></i>
                    Edit
                </button>
                <button class="btn btn-primary btn-sm" onclick="viewProduct('${product.product_id}')">
                    <i class="fas fa-eye"></i>
                    View
                </button>
            </div>
        `;
        {% else %}
        return '';
        {% endif %}
    }
    
    function searchProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const priceRange = document.getElementById('priceFilter').value;
        const stockFilter = document.getElementById('stockFilter')?.value || '';
        const sortBy = document.getElementById('sortFilter').value;
        
        filteredProducts = currentProducts.filter(product => {
            // Search filter
            const matchesSearch = !searchTerm || 
                product.product_name.toLowerCase().includes(searchTerm) ||
                (product.product_make && product.product_make.toLowerCase().includes(searchTerm)) ||
                (product.product_model && product.product_model.toLowerCase().includes(searchTerm)) ||
                product.item_no.toLowerCase().includes(searchTerm);
            
            // Category filter
            const matchesCategory = !category || product.category === category;
            
            // Price filter - use current price (base or custom)
            let matchesPrice = true;
            if (priceRange) {
                {% if current_user.role.startswith('vendor_') %}
                const price = getProductPrice(product);
                {% else %}
                const price = product.custom_price || product.price;
                {% endif %}
                
                switch (priceRange) {
                    case '0-100':
                        matchesPrice = price <= 100;
                        break;
                    case '100-500':
                        matchesPrice = price > 100 && price <= 500;
                        break;
                    case '500-1000':
                        matchesPrice = price > 500 && price <= 1000;
                        break;
                    case '1000+':
                        matchesPrice = price > 1000;
                        break;
                }
            }
            
            // Stock filter (vendor only)
            let matchesStock = true;
            {% if current_user.role.startswith('vendor_') %}
            if (stockFilter) {
                const stock = product.quantity;
                const threshold = product.low_stock_threshold || 10;
                
                switch (stockFilter) {
                    case 'in-stock':
                        matchesStock = stock > threshold;
                        break;
                    case 'low-stock':
                        matchesStock = stock > 0 && stock <= threshold;
                        break;
                    case 'out-of-stock':
                        matchesStock = stock === 0;
                        break;
                }
            }
            {% endif %}
            
            return matchesSearch && matchesCategory && matchesPrice && matchesStock;
        });
        
        // Apply sorting
        filteredProducts.sort((a, b) => {
            switch (sortBy) {
                case 'name_asc':
                    return a.product_name.localeCompare(b.product_name);
                case 'name_desc':
                    return b.product_name.localeCompare(a.product_name);
                case 'price_asc':
                    {% if current_user.role.startswith('vendor_') %}
                    return getProductPrice(a) - getProductPrice(b);
                    {% else %}
                    return (a.custom_price || a.price) - (b.custom_price || b.price);
                    {% endif %}
                case 'price_desc':
                    {% if current_user.role.startswith('vendor_') %}
                    return getProductPrice(b) - getProductPrice(a);
                    {% else %}
                    return (b.custom_price || b.price) - (a.custom_price || a.price);
                    {% endif %}
                {% if current_user.role.startswith('vendor_') %}
                case 'stock_asc':
                    return a.quantity - b.quantity;
                case 'stock_desc':
                    return b.quantity - a.quantity;
                {% endif %}
                default:
                    return 0;
            }
        });
        
        displayProducts();
    }
    
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('priceFilter').value = '';
        if (document.getElementById('stockFilter')) {
            document.getElementById('stockFilter').value = '';
        }
        document.getElementById('sortFilter').value = 'name_asc';
        
        searchProducts();
    }
    
    function showEmptyState(message) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-box"></i>
                </div>
                <h3>${message}</h3>
                <p>Products will appear here when available.</p>
                {% if current_user.role.startswith('vendor_') %}
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                {% endif %}
            </div>
        `;
    }
    
    {% if current_user.role == 'customer_employee' %}
    // Cart functionality for customers
    function changeQuantity(productId, change) {
        const input = document.getElementById(`qty_${productId}`);
        const currentValue = parseInt(input.value);
        const newValue = Math.max(1, currentValue + change);
        const maxValue = parseInt(input.max);
        
        input.value = Math.min(newValue, maxValue);
    }
    
    function addToCart(productId) {
        const product = currentProducts.find(p => p.product_id === productId);
        const quantityInput = document.getElementById(`qty_${productId}`);
        const quantity = parseInt(quantityInput.value);
        
        if (!product || quantity <= 0) {
            showNotification('Invalid product or quantity', 'error');
            return;
        }
        
        // Use custom price if available, otherwise use base price
        const price = product.custom_price || product.price;
        
        // Check if product already in cart
        const existingItemIndex = cart.findIndex(item => item.product_id === productId);
        
        if (existingItemIndex >= 0) {
            cart[existingItemIndex].quantity += quantity;
            cart[existingItemIndex].total = cart[existingItemIndex].quantity * price;
        } else {
            cart.push({
                product_id: productId,
                product_name: product.product_name,
                price: price,
                quantity: quantity,
                total: price * quantity
            });
        }
        
        saveCart();
        updateCartDisplay();
        showNotification(`${product.product_name} added to cart!`, 'success');
        
        // Reset quantity to 1
        quantityInput.value = 1;
    }
    
    function loadCart() {
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            updateCartDisplay();
        }
    }
    
    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }
    
    function updateCartDisplay() {
        const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartTotal = cart.reduce((sum, item) => sum + item.total, 0);
        
        document.getElementById('cartCount').textContent = cartCount;
        document.getElementById('cartItemsText').textContent = `${cartCount} item${cartCount !== 1 ? 's' : ''} in cart`;
        document.getElementById('cartTotalText').textContent = `₹${cartTotal.toLocaleString('en-IN')}`;
        
        const viewCartBtn = document.getElementById('viewCartBtn');
        const cartSummary = document.getElementById('cartSummary');
        
        if (cartCount > 0) {
            viewCartBtn.style.display = 'block';
            cartSummary.classList.add('show');
        } else {
            viewCartBtn.style.display = 'none';
            cartSummary.classList.remove('show');
        }
    }
    
    function viewCart() {
        // Navigate to cart/checkout page
        window.location.href = '/orders?action=cart';
    }
    {% endif %}
    
    {% if current_user.role.startswith('vendor_') %}
    // Vendor functions
    function showAddProductModal() {
        document.getElementById('addProductModal').classList.add('show');
        
        // Focus first field
        setTimeout(() => {
            const productNameField = document.querySelector('#addProductModal [name="product_name"]');
            if (productNameField) {
                productNameField.focus();
            }
        }, 100);
    }
    
    function closeAddProductModal() {
        document.getElementById('addProductModal').classList.remove('show');
        document.getElementById('addProductForm').reset();
        
        // Clear image preview
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
            imagePreview.style.display = 'none';
            imagePreview.innerHTML = '';
        }
    }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        const imagePreview = document.getElementById('imagePreview');
        const imageError = document.getElementById('imageError');
        
        // Clear previous states
        imagePreview.style.display = 'none';
        imagePreview.innerHTML = '';
        imageError.style.display = 'none';
        
        if (!file) return;
        
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            imageError.textContent = 'Please select a valid image file (JPG, PNG, GIF)';
            imageError.style.display = 'block';
            event.target.value = '';
            return;
        }
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            imageError.textContent = 'Image file size should be less than 10MB';
            imageError.style.display = 'block';
            event.target.value = '';
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.innerHTML = `
                <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                <div style="margin-top: 8px; font-size: 0.875rem; color: var(--gray-600);">
                    ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                </div>
            `;
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    function generateItemNumber() {
        // Generate a unique item number
        const timestamp = Date.now().toString().slice(-8);
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `ITM${timestamp}${random}`;
    }
    
    async function submitAddProduct() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        
        // Validate required fields (price removed from validation)
        const requiredFields = ['item_no', 'product_name', 'category', 'quantity'];
        let isValid = true;
        
        for (const field of requiredFields) {
            const input = form.querySelector(`[name="${field}"]`);
            const errorSpan = input.parentNode.querySelector('.form-error');
            
            if (!input.value.trim()) {
                if (errorSpan) {
                    errorSpan.textContent = `${field.replace('_', ' ')} is required`;
                    errorSpan.style.display = 'block';
                }
                input.style.borderColor = 'var(--secondary-red)';
                isValid = false;
            } else {
                if (errorSpan) {
                    errorSpan.style.display = 'none';
                }
                input.style.borderColor = 'var(--gray-300)';
            }
        }
        
        if (!isValid) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            // Show loading state
            const submitBtn = document.querySelector('#addProductModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            submitBtn.disabled = true;
            
            const response = await fetch('/api/products', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Product created successfully! Set customer pricing using the dropdown above.', 'success');
                closeAddProductModal();
                loadProducts(); // Reload products list
            } else {
                showNotification(result.message || 'Failed to create product', 'error');
            }
        } catch (error) {
            console.error('Error creating product:', error);
            showNotification('Failed to create product', 'error');
        } finally {
            // Restore button state
            const submitBtn = document.querySelector('#addProductModal .btn-primary');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    function editProduct(productId) {
        showNotification('Edit Product functionality coming soon!', 'info');
    }
    
    function viewProduct(productId) {
        showNotification('View Product functionality coming soon!', 'info');
    }
    
    // Generate item number when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const itemNoField = document.getElementById('productItemNo');
        if (itemNoField) {
            itemNoField.value = generateItemNumber();
        }
    });
    {% endif %}
</script>
{% endblock %}