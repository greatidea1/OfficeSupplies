{% extends "base.html" %}

{% block title %}Products - Office Supplies System{% endblock %}

{% block extra_css %}
<style>

    /* Placeholder for missing product images */
    .product-image-placeholder {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
        font-size: 48px;
        border: 1px solid var(--gray-200);
    }

    .product-image-placeholder i {
        opacity: 0.5;
    }

    /* Modal improvements */
    .modal-content {
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @media (max-width: 768px) {
        .modal-body > div:first-child {
            grid-template-columns: 1fr !important;
            gap: 16px !important;
        }
        
        .product-card {
            padding: 16px;
        }
    }

    .products-container {
        padding: 32px 0;
    }
    
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
    }
    
    .filters-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        margin-bottom: 32px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-label {
        font-weight: 500;
        color: var(--gray-700);
        font-size: 0.875rem;
    }
    
    .search-section {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 12px 16px;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }
    
    .product-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: fit-content;
    }
    
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-blue);
    }

    .product-card img {
        transition: opacity 0.3s ease;
    }

    .product-card img[src=""] {
        display: none;
    }
    
    .product-card:hover img {
        transform: scale(1.02);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }
    
    .product-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .product-category {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-bottom: 8px;
    }
    
    .product-details {
        margin-bottom: 16px;
    }
    
    .product-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }
    
    .product-info-label {
        color: var(--gray-600);
    }
    
    .product-info-value {
        font-weight: 500;
        color: var(--gray-900);
    }
    
    /* Updated pricing styles for editable rates */
    .product-price-section {
        margin-bottom: 16px;
        padding: 12px;
        background: var(--gray-50);
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .product-price-section.editable {
        border-color: var(--primary-blue);
        background: rgba(37, 99, 235, 0.05);
    }
    
    .product-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .price-input {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        background: none;
        border: none;
        outline: none;
        width: 120px;
        padding: 2px;
        border-bottom: 2px solid var(--primary-blue);
    }
    
    .price-actions {
        display: none;
        gap: 4px;
        margin-left: auto;
    }
    
    .product-price-section.editing .price-actions {
        display: flex;
    }
    
    .price-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .price-btn.save {
        background: var(--secondary-green);
        color: white;
    }
    
    .price-btn.cancel {
        background: var(--gray-400);
        color: white;
    }
    
    .price-btn:hover {
        transform: scale(1.1);
    }
    
    .base-price-indicator {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: normal;
        margin-top: 2px;
    }
    
    .custom-price-indicator {
        font-size: 0.75rem;
        color: var(--secondary-green);
        font-weight: 500;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .product-gst {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 8px;
    }
    
    .no-customer-message {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        color: var(--secondary-orange);
        text-align: center;
        font-weight: 500;
    }
    
    .product-stock {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .stock-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .stock-high {
        background: var(--secondary-green);
    }
    
    .stock-medium {
        background: var(--secondary-orange);
    }
    
    .stock-low {
        background: var(--secondary-red);
    }
    
    .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
    }
    
    .btn-add-cart {
        flex: 1;
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-add-cart:hover {
        background: var(--primary-blue-dark);
        transform: translateY(-1px);
    }

    .btn-add-cart:hover:not(:disabled) {
        background: var(--primary-blue-dark) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .btn-add-cart:disabled {
        background: var(--gray-400) !important;
        cursor: not-allowed;
        transform: none !important;
    }

    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .quantity-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .quantity-input {
        width: 60px;
        padding: 8px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        text-align: center;
    }
    
    .quantity-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--gray-300);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
        background: var(--gray-50);
        border-color: var(--primary-blue);
    }

    .quantity-btn:hover:not(:disabled) {
        background: var(--gray-50) !important;
        border-color: var(--primary-blue) !important;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-500);
        background: white;
        border-radius: 16px;
        border: 1px solid var(--gray-200);
        grid-column: 1 / -1;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .cart-summary {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        min-width: 200px;
        z-index: 100;
        display: none;
    }
    
    .cart-summary.show {
        display: block;
        animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .cart-items-count {
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 8px;
    }
    
    .cart-total {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 12px;
    }
    
    @media (max-width: 768px) {
        .products-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .search-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-input {
            min-width: auto;
        }
        
        .cart-summary {
            position: relative;
            bottom: auto;
            right: auto;
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="products-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    {% if current_user.role.startswith('vendor_') %}
                        Product Management
                    {% else %}
                        Product Catalog
                    {% endif %}
                </h1>
                <p style="color: var(--gray-600); margin: 8px 0 0 0;">
                    {% if current_user.role.startswith('vendor_') %}
                        Manage your product inventory and customer-specific pricing
                    {% else %}
                        Browse and order office supplies
                    {% endif %}
                </p>
            </div>
            <div style="display: flex; gap: 12px;">
                {% if current_user.role == 'customer_employee' %}
                <button class="btn btn-secondary" onclick="viewCart()" id="viewCartBtn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    View Cart (<span id="cartCount">0</span>)
                </button>
                {% endif %}
                {% if current_user.role.startswith('vendor_') %}
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Customer Selection Message for Vendors -->
        {% if current_user.role.startswith('vendor_') %}
        <div class="no-customer-message" id="noCustomerMessage">
            <i class="fas fa-info-circle"></i>
            Select a customer from the dropdown below to view and edit customer-specific pricing
        </div>
        {% endif %}
        
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                {% if current_user.role.startswith('vendor_') %}
                <div class="filter-group">
                    <label class="filter-label">Customer</label>
                    <select class="form-control" id="customerFilterProducts">
                        <option value="">Select Customer for Pricing</option>
                    </select>
                </div>
                {% endif %}
                
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="form-control" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Price Range</label>
                    <select class="form-control" id="priceFilter">
                        <option value="">All Prices</option>
                        <option value="0-100">₹0 - ₹100</option>
                        <option value="100-500">₹100 - ₹500</option>
                        <option value="500-1000">₹500 - ₹1,000</option>
                        <option value="1000+">₹1,000+</option>
                    </select>
                </div>
                
                {% if current_user.role.startswith('vendor_') %}
                <div class="filter-group">
                    <label class="filter-label">Stock Status</label>
                    <select class="form-control" id="stockFilter">
                        <option value="">All Stock</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                {% endif %}
                
                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select class="form-control" id="sortFilter">
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="price_asc">Price (Low to High)</option>
                        <option value="price_desc">Price (High to Low)</option>
                        {% if current_user.role.startswith('vendor_') %}
                        <option value="stock_asc">Stock (Low to High)</option>
                        <option value="stock_desc">Stock (High to Low)</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            
            <div class="search-section">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search products by name, make, model..."
                >
                <button class="btn btn-primary" onclick="searchProducts()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <!-- Products will be loaded here -->
            <div style="grid-column: 1 / -1; padding: 40px; text-align: center;">
                <div class="spinner"></div>
                Loading products...
            </div>
        </div>
    </div>
</div>

<!-- Cart Summary (for customers) -->
{% if current_user.role == 'customer_employee' %}
<div class="cart-summary" id="cartSummary">
    <div class="cart-items-count" id="cartItemsText">0 items in cart</div>
    <div class="cart-total" id="cartTotalText">₹0.00</div>
    <button class="btn btn-primary btn-sm" onclick="viewCart()">
        <i class="fas fa-shopping-cart"></i>
        View Cart
    </button>
</div>
{% endif %}

<!-- Add Product Modal (for vendors) - UPDATED WITHOUT RATE FIELD -->
{% if current_user.role.startswith('vendor_') %}
<div class="modal" id="addProductModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Add New Product</h3>
            <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" enctype="multipart/form-data">
                <!-- Basic Product Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Item Number <span style="color: var(--secondary-red);">*</span></label>
                        <input type="text" class="form-control" name="item_no" id="productItemNo" required>
                        <span class="form-help">Unique identifier for the product</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category <span style="color: var(--secondary-red);">*</span></label>
                        <select class="form-control" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Office Stationery">Office Stationery</option>
                            <option value="Computer Accessories">Computer Accessories</option>
                            <option value="Furniture">Furniture</option>
                            <option value="Office Equipment">Office Equipment</option>
                            <option value="Printing Supplies">Printing Supplies</option>
                            <option value="Storage & Organization">Storage & Organization</option>
                            <option value="Cleaning Supplies">Cleaning Supplies</option>
                            <option value="Safety Equipment">Safety Equipment</option>
                            <option value="Communication Equipment">Communication Equipment</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Product Name <span style="color: var(--secondary-red);">*</span></label>
                    <input type="text" class="form-control" name="product_name" required>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Make/Manufacturer</label>
                        <input type="text" class="form-control" name="product_make">
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="product_model">
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description/Details</label>
                    <textarea class="form-control" name="description" rows="3" placeholder="Product description, features, specifications..."></textarea>
                    <span class="form-error"></span>
                </div>
                
                <!-- Stock Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Quantity <span style="color: var(--secondary-red);">*</span></label>
                        <input type="number" class="form-control" name="quantity" min="0" required>
                        <span class="form-help">Number of units in stock</span>
                        <span class="form-error"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" class="form-control" name="low_stock_threshold" value="10" min="0">
                        <span class="form-help">Alert when stock falls below this number</span>
                        <span class="form-error"></span>
                    </div>
                </div>
                
                <!-- Note about pricing -->
                <div class="form-group">
                    <div style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3); border-radius: 8px; padding: 16px; color: var(--primary-blue);">
                        <i class="fas fa-info-circle"></i>
                        <strong>Pricing:</strong> After creating the product, set customer-specific pricing using the pricing editor on the products page.
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">GST Rate (%)</label>
                    <select class="form-control" name="gst_rate">
                        <option value="0">0% (Exempt)</option>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18" selected>18%</option>
                        <option value="28">28%</option>
                    </select>
                    <span class="form-error"></span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">HSN Code</label>
                    <input type="text" class="form-control" name="hsn_code" placeholder="e.g., 84713000">
                    <span class="form-help">Harmonized System of Nomenclature code for tax classification</span>
                    <span class="form-error"></span>
                </div>
                
                <!-- Update the file input in the Add Product Modal -->
                <div class="form-group">
                    <label class="form-label">Product Image</label>
                    <input type="file" 
                        class="form-control" 
                        name="product_image" 
                        accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/tiff,image/svg+xml,image/x-icon,image/avif,image/jfif" 
                        onchange="handleImageUpload(event)">
                    <span class="form-help">Upload product image (All image formats supported - JPEG, PNG, GIF, WebP, BMP, TIFF, SVG, ICO, AVIF - max 16MB). Images will be automatically resized to 800x800 pixels.</span>
                    <span class="form-error" id="imageError"></span>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" style="margin-top: 12px; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; display: none;">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitAddProduct()">
                <i class="fas fa-plus"></i>
                Create Product
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}

<script>

    // Clean products JavaScript without template syntax issues
let currentProducts = [];
let filteredProducts = [];
let categories = [];
let cart = [];
let selectedCustomerId = null;
let customerPricing = {};

// Get user role from template safely
const USER_ROLE = '{{ current_user.role if current_user else "none" }}';
const IS_CUSTOMER = USER_ROLE.startsWith('customer_');
const IS_VENDOR = USER_ROLE.startsWith('vendor_');

console.log('User role:', USER_ROLE);
console.log('Is customer:', IS_CUSTOMER);
console.log('Is vendor:', IS_VENDOR);

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing products page');
    loadProducts();
    setupEventListeners();
    
    if (IS_CUSTOMER) {
        loadCart();
    }
    
    if (IS_VENDOR) {
        setupCustomerPricingSystem();
    }
});

async function loadProducts() {
    try {
        console.log('Loading products...');
        const response = await apiCall('/products');
        console.log('Products response:', response);
        
        const grid = document.getElementById('productsGrid');
        
        if (response.success && response.products) {
            console.log('Products loaded successfully:', response.products.length);
            currentProducts = response.products;
            filteredProducts = [...currentProducts];
            categories = response.categories || [];
            
            populateCategoryFilter();
            
            if (IS_VENDOR) {
                await loadCustomerPricing();
            }
            
            displayProducts();
        } else {
            console.error('Failed to load products:', response);
            showEmptyState('No products available');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        showEmptyState('Error loading products');
    }
}

function displayProducts() {
    const grid = document.getElementById('productsGrid');
    
    if (filteredProducts.length === 0) {
        showEmptyState('No products found');
        return;
    }
    
    console.log('Displaying products for role:', USER_ROLE);
    
    if (IS_CUSTOMER) {
        // Customer view
        displayCustomerProducts();
    } else if (IS_VENDOR) {
        // Vendor view
        displayVendorProducts();
    }
    
    console.log('Products displayed successfully');
}

function displayCustomerProducts() {
    const grid = document.getElementById('productsGrid');
    
    grid.innerHTML = filteredProducts.map(product => {
        const isOutOfStock = product.quantity === 0;
        const effectivePrice = product.custom_price || product.price || 0;
        const gstAmount = (effectivePrice * (product.gst_rate || 18)) / 100;
        
        // Handle product image
        let productImage = '';
        if (product.image_urls && product.image_urls.length > 0) {
            productImage = product.image_urls[0];
            if (productImage && !productImage.startsWith('http') && !productImage.startsWith('/uploads/')) {
                productImage = `/uploads/products/${productImage}`;
            }
        }
        
        // Skip products without pricing
        if (effectivePrice === 0 && !product.custom_price) {
            return '';
        }
        
        return `
            <div class="product-card" onclick="viewProductDetails('${product.product_id}')" style="cursor: pointer;">
                <!-- Product Name -->
                <div style="text-align: left; margin-bottom: 16px; font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">
                    ${product.product_name}
                </div>
                
                <!-- Product Image -->
                <div style="text-align: center; margin-bottom: 16px;">
                    ${productImage ? `
                        <img src="${productImage}" 
                             alt="${product.product_name}" 
                             style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 100%; height: 200px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                            <i class="fas fa-box"></i>
                        </div>
                    ` : `
                        <div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 48px; border: 1px solid var(--gray-200);">
                            <i class="fas fa-box"></i>
                        </div>
                    `}
                </div>
                
                <!-- Product Details -->
                <div style="margin-bottom: 16px;">
                    ${product.product_make ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Make:</span>
                            <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.product_make}</span>
                        </div>
                    ` : ''}
                    
                    ${product.product_model ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Model:</span>
                            <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.product_model}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray-600); font-size: 0.875rem;">Category:</span>
                        <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.category}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray-600); font-size: 0.875rem;">Item No:</span>
                        <span style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem;">${product.item_no}</span>
                    </div>
                </div>
                
                <!-- Price Section -->
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 4px;">
                        ₹${effectivePrice.toLocaleString('en-IN')}
                        ${product.custom_price ? '<span style="font-size: 0.75rem; color: var(--secondary-green); margin-left: 8px;">Special Price</span>' : ''}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500);">
                        + ₹${gstAmount.toFixed(2)} GST (${product.gst_rate || 18}%)
                    </div>
                </div>
                
                <!-- Action Section -->
                <div onclick="event.stopPropagation()" style="display: flex; gap: 12px;">
                    <!-- Qty Section -->
                    <div style="flex: 1; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; align-items: center;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Qty</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="changeQuantity('${product.product_id}', -1)" 
                                    ${isOutOfStock ? 'disabled' : ''} 
                                    style="width: 28px; height: 28px; border: 1px solid var(--gray-300); background: white; border-radius: 4px; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'}; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                   id="qty_${product.product_id}" 
                                   value="1" 
                                   min="1" 
                                   max="${product.quantity}" 
                                   ${isOutOfStock ? 'disabled' : ''} 
                                   style="width: 50px; padding: 6px; border: 1px solid var(--gray-300); border-radius: 4px; text-align: center; font-size: 0.875rem; font-weight: 600;">
                            <button onclick="changeQuantity('${product.product_id}', 1)" 
                                    ${isOutOfStock ? 'disabled' : ''} 
                                    style="width: 28px; height: 28px; border: 1px solid var(--gray-300); background: white; border-radius: 4px; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'}; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- +Cart Section -->
                    <div style="flex: 1;">
                        <button onclick="addToCart('${product.product_id}')" 
                                ${isOutOfStock ? 'disabled' : ''} 
                                data-price="${effectivePrice}" 
                                style="width: 100%; height: 100%; background: ${isOutOfStock ? 'var(--gray-400)' : 'var(--primary-blue)'}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'}; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: all 0.3s ease;">
                            <i class="fas fa-cart-plus" style="font-size: 1.25rem;"></i>
                            <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${isOutOfStock ? 'Out of Stock' : '+Cart'}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).filter(card => card !== '').join('');
    
    if (grid.innerHTML.trim() === '') {
        showEmptyState('No products available with pricing');
    }
}

function displayVendorProducts() {
    const grid = document.getElementById('productsGrid');
    
    grid.innerHTML = filteredProducts.map(product => `
        <div class="product-card">
            <div class="product-header">
                <div>
                    <div class="product-category">${product.category}</div>
                    <div class="product-name">${product.product_name}</div>
                </div>
                ${getStockIndicator(product)}
            </div>
            
            <div class="product-details">
                ${product.product_make ? `
                    <div class="product-info-row">
                        <span class="product-info-label">Make:</span>
                        <span class="product-info-value">${product.product_make}</span>
                    </div>
                ` : ''}
                ${product.product_model ? `
                    <div class="product-info-row">
                        <span class="product-info-label">Model:</span>
                        <span class="product-info-value">${product.product_model}</span>
                    </div>
                ` : ''}
                <div class="product-info-row">
                    <span class="product-info-label">Item No:</span>
                    <span class="product-info-value">${product.item_no}</span>
                </div>
                <div class="product-info-row">
                    <span class="product-info-label">Stock:</span>
                    <span class="product-info-value">${product.quantity} units</span>
                </div>
            </div>
            
            ${getPriceSection(product)}
            ${getProductActions(product)}
        </div>
    `).join('');
    
    // Update price indicators for vendor users
    if (typeof updatePriceIndicator === 'function') {
        filteredProducts.forEach(product => {
            updatePriceIndicator(product.product_id);
        });
    }
}

// Cart functions for customer users
function changeQuantity(productId, change) {
    if (!IS_CUSTOMER) return;
    
    const input = document.getElementById(`qty_${productId}`);
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, currentValue + change);
    const maxValue = parseInt(input.max) || 999;
    
    input.value = Math.min(newValue, maxValue);
}

function addToCart(productId) {
    if (!IS_CUSTOMER) return;
    
    console.log('Adding to cart:', productId);
    
    const product = currentProducts.find(p => p.product_id === productId);
    const quantityInput = document.getElementById(`qty_${productId}`);
    
    if (!product || !quantityInput) {
        showNotification('Error adding product to cart', 'error');
        return;
    }
    
    const quantity = parseInt(quantityInput.value) || 1;
    const price = product.custom_price || product.price || 0;
    
    if (price === 0) {
        showNotification('Product price not available', 'error');
        return;
    }
    
    // Check if product already in cart
    const existingItemIndex = cart.findIndex(item => item.product_id === productId);
    
    if (existingItemIndex >= 0) {
        cart[existingItemIndex].quantity += quantity;
        cart[existingItemIndex].total = cart[existingItemIndex].quantity * price;
    } else {
        cart.push({
            product_id: productId,
            product_name: product.product_name,
            price: price,
            quantity: quantity,
            total: price * quantity
        });
    }
    
    saveCart();
    updateCartDisplay();
    showNotification(`${product.product_name} added to cart!`, 'success');
    
    // Reset quantity to 1
    quantityInput.value = 1;
}

function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCartDisplay() {
    const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartTotal = cart.reduce((sum, item) => sum + item.total, 0);
    
    // Update various cart display elements
    const elements = [
        { id: 'cartCount', value: cartCount },
        { id: 'cartCountHeader', value: cartCount },
        { id: 'cartItemsText', value: `${cartCount} item${cartCount !== 1 ? 's' : ''} in cart` },
        { id: 'cartTotalText', value: `₹${cartTotal.toLocaleString('en-IN')}` }
    ];
    
    elements.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
    
    // Show/hide cart elements
    const viewCartBtn = document.getElementById('viewCartBtn');
    const cartSummary = document.getElementById('cartSummary');
    
    if (viewCartBtn) viewCartBtn.style.display = cartCount > 0 ? 'block' : 'none';
    if (cartSummary) cartSummary.classList.toggle('show', cartCount > 0);
}

function loadCart() {
    if (!IS_CUSTOMER) return;
    
    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
        cart = JSON.parse(savedCart);
        updateCartDisplay();
    }
}

function viewCart() {
    window.location.href = '/orders?action=cart';
}

// Other helper functions
function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchProducts();
        }
    });
    
    ['categoryFilter', 'priceFilter', 'stockFilter', 'sortFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', searchProducts);
        }
    });
}

function populateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;
    
    const uniqueCategories = [...new Set(currentProducts.map(p => p.category))];
    
    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
        uniqueCategories.map(category => 
            `<option value="${category}">${category}</option>`
        ).join('');
}

function searchProducts() {
    // Apply filters and sorting logic here
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const priceRange = document.getElementById('priceFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    
    // Filter logic here...
    filteredProducts = currentProducts.filter(product => {
        // Search filter
        const matchesSearch = !searchTerm || 
            product.product_name.toLowerCase().includes(searchTerm) ||
            (product.product_make && product.product_make.toLowerCase().includes(searchTerm)) ||
            (product.product_model && product.product_model.toLowerCase().includes(searchTerm));
        
        // Category filter
        const matchesCategory = !category || product.category === category;
        
        return matchesSearch && matchesCategory;
    });
    
    displayProducts();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('priceFilter').value = '';
    if (document.getElementById('stockFilter')) {
        document.getElementById('stockFilter').value = '';
    }
    document.getElementById('sortFilter').value = 'name_asc';
    
    searchProducts();
}

function showEmptyState(message = 'No products found') {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--gray-500);">
            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">
                <i class="fas fa-box"></i>
            </div>
            <h3>${message}</h3>
            <p>Products will appear here when available.</p>
        </div>
    `;
}

// Product details modal
function viewProductDetails(productId) {
    console.log('Viewing product details:', productId);
    // Modal implementation here...
}

</script>

{% endblock %}